{% extends 'base.html' %} 

{% load static %}


{% block content %}
<head>
  <script type="text/javascript">
    $(".sidebar").addClass('close');
  </script> 
  <script src="//code.jquery.com/jquery.min.js"></script>
  <link rel="stylesheet" type="text" href="{% static '/bootstrap-5.1.3-dist/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" media="screen" href="{% static '/css/bootstrap.min.css' %}">
  <link href="{% static '/css/bootstrap-toggle.min.css' %}" rel="stylesheet">
  <script src="{% static '/js/bootstrap-toggle.min.js' %}"></script>
  <link rel="stylesheet" type="text/css" href="{% static '/css/select2.min.css' %}" />
  <link rel="stylesheet" type="text/css" media="screen" href="{% static '/css/select2.min.css' %}">
  <link rel="stylesheet" href="{% static '/css/jquery-ui.css' %}">
  <link rel="stylesheet" href="{% static '/css/font-awesome.min.css' %}">
  <script src="{% static 'js/timepicker.js' %}"></script>  
  <script src="{% static '/js/jquery.min.js' %}"></script>
  <script src="{% static '/js/jquery.min4.js' %}"></script> 
  <script src="{% static '/js/select2.min.js' %}"></script>
  <script src="{% static '/js/jquery.dataTables.min.js' %}"></script>
  <link href="{% static '/css/jquery.dataTables.min.css' %}"  rel="stylesheet"/>    
  <link rel="stylesheet" href="{% static '/css/jquery-ui.css' %}">
  <script src="{% static '/js/jquery-ui.js' %}"></script>
  <link rel="stylesheet" type="text/css" href="{% static '/css/quicksand.css' %} ">
  <link rel="stylesheet" type="text/css" href="{% static '/css/lato.css' %} ">
  <script type="text/javascript" src="{% static '/daterangepicker-master/moment.min.js'%}"></script>
  <script type="text/javascript" src="{% static '/daterangepicker-master/daterangepicker.js'%}"></script>
  <link rel="stylesheet" type="text/css" href="{%static '/daterangepicker-master/daterangepicker.css'%}" />
  <link rel="stylesheet" type="text/css" media="screen" href="{% static '/css/forms_common.css' %}">  
   
  
  <style>

  .nav-tabs .nav-link.active{
    background-color: #75ef6a;
    border-color: #343a40;
  }
    * {
    box-sizing: border-box;
  }
  body {
          font-family: 'Quicksand', sans-serif;;
          height: 100%;
          margin: 0;
          }
  
  
      
        input[type=text]
        {
                width: 100%;
                padding: 12px 20px;
                margin: 8px 0;
                display: block;
                /* border: 1.5px solid rgb(14, 12, 12); */
                border-radius: 4px;
                box-sizing: border-box;
        }
      
        input[type=submit] {
                width: 40%;
                text-align: center;
                background-color: #4CAF50;
               
                padding: 14px 20px;
                margin: 8px 0;
                border: none;
                border-radius: 4px;
                cursor: pointer;
        }
      
        input[type=submit]:hover {
                background-color: #45a049;
                text-align: center;
        }
      
      
        input[type=button]:hover {
                background-color: #45a049;
                text-align: center;
        }
        /* #viewbtn{
          margin-left:1050px;
        } */
      
        .inputtag{
          height:20px;
        }
        .button {
    padding: 15px 25px;
    font-size: 12px;
    text-align: center;
    margin-left: 2em;
    cursor: pointer;
    outline: none;
    color: #fff;
    background-color: #04AA6D;
    border: none;
    border-radius: 15px;
   
  }
  
  .button:hover {background-color: #3e8e41}
  
  .button:active {
    background-color: #77e046;
    box-shadow: 0 5px #666;
    transform: translateY(4px);
  }
  .modal-content{
  border: solid !important;
  border-width: 1px !important;
}
.modal-header{
  background-color: #3c84cd !important;
  color: #fff;
  border-radius: inherit;
}
.close span{
  color: #fff !important;
}
.close span:hover{
  color: #fff !important;
}
      </style>
 
 <style>
  .modal.left .modal-dialog,
  .modal.right .modal-dialog {
    position: fixed;
    margin: auto;
    width: 1200px;
    height: 100%;
    -webkit-transform: translate3d(0%, 0, 0);
    -ms-transform: translate3d(0%, 0, 0);
    -o-transform: translate3d(0%, 0, 0);
    transform: translate3d(0%, 0, 0);
  }

  .modal.left .modal-content,
  .modal.right .modal-content {
    height: 100%;
    overflow-y: auto;
  }

  .modal.left .modal-body,
  .modal.right .modal-body {
    padding: 15px 15px 80px;
  }

  /*Left*/
  .modal.left.fade .modal-dialog {
    left: -320px;
    -webkit-transition: opacity 0.3s linear, left 0.3s ease-out;
    -moz-transition: opacity 0.3s linear, left 0.3s ease-out;
    -o-transition: opacity 0.3s linear, left 0.3s ease-out;
    transition: opacity 0.3s linear, left 0.3s ease-out;
  }

  .modal.left.fade.show .modal-dialog {
    left: 0;
  }

  /*Right*/
  .modal.right.fade .modal-dialog {
    right: -320px;
    -webkit-transition: opacity 0.3s linear, right 0.3s ease-out;
    -moz-transition: opacity 0.3s linear, right 0.3s ease-out;
    -o-transition: opacity 0.3s linear, right 0.3s ease-out;
    transition: opacity 0.3s linear, right 0.3s ease-out;
  }

  .modal.right.fade.show .modal-dialog {
    right: 0;
  }

  /* ----- MODAL STYLE ----- */
  .modal-content {
    border-radius: 0;
    border: none;
  }

  .modal-header {
    border-bottom-color: #EEEEEE;
    background-color: #FAFAFA;
  }

  .modal-lg {
    max-width: 70% !important;
  }

  .modal {
    pointer-events: none;
  }
 </style>
    
</head>

<body data-media-url="{% get_media_prefix %}">
  <h3 class="report_heading">D.O Letters Marked to me</h3>
  <br>
  <br>
  <div class="container-fluid">
        <div class="row ">
          <div class="col-6" style="overflow: auto;">
            
            <table class="table  table-bordered table-data table-sm" id="view_table"
              style="width: 100%; font-size: 1em; font-family:'Lato', sans-serif">
              <thead style="white-space: nowrap; color:white;text-align: left;">
                <th style="width: 3%;"> S.No.</th>
                <th style="width: 15%;">D.O.Date</th>
                <th style="width: 50%;">D.O.Letter No.</th>
                <th style="width: 7%;">Received From</th>
                <th style="width: 25%;">Reply Status</th>
               
                
              </thead>
              <tbody>
                {% if letters %}  
                {% for i in letters  %}
                  <tr style="font-size: 1em; font-family:'Lato', sans-serif">
                    <td style="width: 3%;"> {{forloop.counter}}</td>
                    <td style="width: 15%;" >{{i.do_letter_date}}</td>
                    <td style="width: 50%;"><a href="" onclick="detailsyyyy('{{i.id_upload_id}}','{{i.id}}','D'); return false;" title="Click to View Details" id="dolink"> {{i.do_letter_no}}</a></td>
                    
                    <td style="width: 7%;">{{i.rcvd_from}}</td>
                    {% if i.status_flag is False %}
                    <td style="width: 25%;"><a type="button" data-toggle="modal" data-target="#upload_reply"  href="" style=" color: red;" onclick="upload_reply('{{i.id}}'); return false;" title="Click to Upload Reply">Pending</a></td>
                    {% else %}
                    <td style="width: 25%; color: green;"><a href="" onclick="detailsyyyy('{{i.id_upload_id}}','{{i.id}}',`R`); return false;" data-toggle="tooltip"
                      title="Click to View Details" style="color: green;"> Replied on {{i.date_of_reply }}</a></td>
                    {% endif %}
                </tr>
               
                {% endfor %}
                {% endif %}
              </tbody>
            </table>
          </div>
          <div class="col-6">
           
            <div id="view1">
              <ul class="nav nav-tabs nav-fill mb-2">
                <li class="nav-item">
                  <a class="nav-link active" id="det" data-toggle="tab" href="#details">Details</a>
                </li>
                
                <li class="nav-item">
                  <a class="nav-link" id="hist" data-toggle="tab" href="#history">View Reply</a>
                  <a class="nav-link" id="no_reply_tab" data-toggle="modal" data-target="#upload_reply"  href="" onclick="upload_reply('{{i.id}}'); return false;" title="Click to Upload Reply">Send Reply</a>
                </li>
                <!-- <li class="nav-item">
                </li> -->
              </ul>

              <div class="tab-content">
                <div id="details" class="container-fluid tab-pane active">
                
                  <div class="rectangle m-3" id="preiew_div" >
                    <textarea class="form-control mb-2 mr-sm-2" id="piframetest" style="width: 100%; height:100%" readonly></textarea>
                    <iframe id="iframetest"  style="width:100%; height:600px;" frameborder="0" ></iframe>
                    <br>
                    <a  style="float: right;" class="btn btn-primary" target="_blank" id="aiframetest" >Open</a>
                  </div>
                </div>



                <div id="history" class="container-fluid tab-pane table responsive">
                  <table class="table  table-bordered table-data table-sm" id="status_table"
                    style="width: 100%; font-size: 1em; font-family:'Lato', sans-serif">
                    <thead style="white-space: nowrap; color:white;text-align: center; height: 35px;">
                      <th style="width: 25%;">Reply Date</th>
                      <th style="width: 15%;">Reply Sent(Yes/No)</th>
                      <th style="width: 60%;">Attachment</th>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#do_letters_modal_view" id="domodjuxt">
                    View in Juxtapose Format
                  </button>
                  
                </div>
              </div>

            </div>
          </div>
          <!--end table div-->
        </div>
      </div>

<!-- Upload reply modal -->

<div class="modal fade" id="upload_reply" tabindex="-1" role="dialog" aria-labelledby="uploadModal" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Upload Reply</h5>
        <button type="button" class="btn btn-danger" data-dismiss="modal" aria-label="Close" >Close
          <!-- <span aria-hidden="true" style="color: red;">&times;</span> -->
        </button>
      </div>
      <div class="modal-body">
          <form action="" method="POST" class="form-group" enctype="multipart/form-data">
              {% csrf_token %}
              <input type="text" id="reply_id" name="reply_id" hidden>
              <div class="row mx-2">
                <div class="form-check form-check-inline mx-2">
                  <input class="form-check-input" type="radio" name="description" id="noted" value="Uploadreply"  checked onclick="disabledCheckBox(this.value)">
                  <label class="form-check-label" for="inlineRadio1" >Upload reply</label>
                </div>
                <div class="form-check form-check-inline mx-2">
                  <input class="form-check-input" type="radio" name="description" id="reply" value="Noted" onclick="disabledCheckBox(this.value)">
                  <label class="form-check-label" for="inlineRadio2">Noted</label>
                </div>
            </div>
                  <div class="row mt-2" id="dis">
                      <div class="col-md-3" >
                          <label for ='reply_file' class="mr-sm-2">Upload Reply </label>
                      </div>
                      <div class="col-md-9">
                        <input name="reply_file" id="reply_file" type="file" accept="application/pdf" style="width: 100%;" onchange="Filevalidation()"/>
                        <p style="color: blue; ">Accepted types: .pdf<br> File size should not exceed 200kB </p>
                      </div>
                  </div>

              <button type="submit" id="submitid1" disabled class="btn btn-primary mb-2 mt-4" style="background-color: rgb(8, 148, 8);" {% if request.session.userrole == 'guest' %} hidden {% endif %}>Submit</button>             
          </form>
      </div>
    </div>
  </div>
</div>

<!-- Juxtapose modal -->
<div class="modal right fade" id="do_letters_modal_view" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content modal-content-full-width ">
      <div class="modal-header modal-header-full-width ">
        <h3 style="font-family: 'Lato', sans-serif;" id="ModalView">
          <center><b>Details of D.O. <label id="setdodata"></label></b></center>
        </h3>

        <button type="button" class="btn btn-danger" data-dismiss="modal" aria-label="Close" >Close</button>
      </div>
      <div class="modal-body">

        <div class="container-fluid">
          <div class="row ">

            <div class="col-6" style="overflow: auto;">
              <h3>D.O Letter</h3>
              <div class="rectangle m-3" id="preiew_div">
                <iframe id="iframetestsh" style="width:550px; height:600px;" frameborder="0"></iframe>
              </div>
            </div>
            <div class="col-6">
              <h3><label id="setreplydata"></label>
              <div class="row mt-2" width="100%">
                <div class="container">
                  
                  <!-- <table class="table table-striped table-data table-sm" id="modal_table">
                    <thead>
                      <th style="width: 20%;">Action By</th>
                      <th style="width: 15%;">Reply Date</th>
                      <th style="width: 40%;">Reply Rec'd(Yes/No)</th>
                      <th style="width: 20%;">Attachment</th>
                    </thead>
                    <tbody>
                    </tbody>
                  </table> -->
                  <iframe id="iframetest111" style="width:550px; height:600px;" frameborder="0"></iframe>
                </div>

              </div>
            </div>

          </div>

        </div>
      </div>
    </div>
  </div>
</div>

      <!-- <div class="modal fade" id="upload_reply" tabindex="-1" role="dialog" aria-labelledby="uploadModal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">Upload Reply</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
                <form action="" method="POST" class="form-group" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="text" id="reply_id" name="reply_id" hidden>
                       
                        <div class="row mt-2">
                            <div class="col-md-3" >
                                <label for ='reply_file' class="mr-sm-2">Upload Reply </label>
                            </div>
                            <div class="col-md-9" >
                              <input name="reply_file" id="reply_file" type="file" accept="application/pdf" style="width: 100%;" onchange="Filevalidation()"/>
                              <p style="color: blue; ">Accepted types: .pdf<br> File size should not exceed 200kB </p>
                            </div>
                        </div>

                    <button type="submit" id="submitid1" disabled class="btn btn-primary mb-2 mt-4" style="background-color: rgb(8, 148, 8);" >Submit</button>             
                </form>
            </div>
          </div>
        </div>
      </div> -->
</body>

<script>

Filevalidation = () => {
  const fi = document.getElementById('reply_file');
  
  // Check if any file is selected.
  if (fi.files.length > 0) {
    for (const i = 0; i <= fi.files.length - 1; i++) {

      const fsize = fi.files.item(i).size;
      const file = Math.round((fsize / 1024));
      // The size of the file.
      if (file >= 200) {
        alert("File too Big, please select a file less than 200KB");
        }
         else {
        // document.getElementById('size').innerHTML = '<b>'
        // + file + '</b> KB';
        document.getElementById('submitid1').disabled=false;
      }
    }
  }
}

$(document).ready(function () {

// $('#table_id').DataTable();
// $('#status_table').DataTable();
$('#view_table').DataTable();
$('#aiframetest').hide();
$('#no_reply_tab').hide();
$('#domodjuxt').hide();
});


 function upload_reply(id){
    
    document.getElementById('reply_id').value=id   

    }

    function disabledCheckBox(val){
      // alert(val)
      if(val=='Noted'){
        $('#reply_file').prop('disabled',true)
        document.getElementById('submitid1').disabled=false;
      }else{
        $('#reply_file').prop('disabled',false)
        document.getElementById('submitid1').disabled=true;
      }
      
    }
</script>

<script>
  function detailsyyyy(upload_id, reply_id, stat) 
    {
        // alert("called")
        $('#status_table tbody').empty();
        reply_stat=true;
        $('#piframetest').show();
        $('#iframetest').show();
        $('#aiframetest').show();
        $('#iframetestsh').show();
        data = {
          'upload_id': upload_id,
          'reply_id' : reply_id
        }
        $.ajax({
            url: "{% url 'do_details_ajax' %}",
            method: "GET",
            dataType: "JSON",
            data: data,
            success: function (response) {
              do_details = response.elements;
              reply_details = response.status;
              if(do_details['do_text'] == null)
              {
                $('#piframetest').hide();
                $('#iframetest').show();
                $('#aiframetest').show();
                file = "/media/" + do_details['do_path'];
                $('#iframetest').attr('src', file);
                $('#aiframetest').attr('href', file);
                $('#iframetestsh').attr('src', file);
              }
              else 
              {
                file = "/do_pdf_create/" + do_details['id'];
                $('#piframetest').hide();
                $('#iframetest').show();
                $('#aiframetest').show();
                $('#iframetest').attr('src', file);
                $('#aiframetest').attr('href', file);
                $('#iframetestsh').attr('src', file);
              }
              
              var  row='<tr><td>'+reply_details['date_of_reply']+'</td>';
              reply_file = "/media/" + reply_details['reply_path'];
              if (reply_details['status_flag'] ){
                if (reply_details['reply_path']){
                  attchment=true;
                  row+='<td>Yes</td>';
                  row+=`<td><div class="rectangle m-3" id="preiew_div">
                          <iframe  src="${reply_file}" style="width:100%; height:300px;" frameborder="0" ></iframe>
                          <br>
                          <a  style="float: right;" href="${reply_file}" class="btn btn-primary" target="_blank" >Open</a>
                        </div></td>`;
                        reply_stat=true  
                        $('#iframetest111').attr('src', reply_file); 
                        $('#domodjuxt').show();   
              }
              else{
                reply_stat=true;
                row+='<td>Noted</td>';
                row+='<td style="text-align:center;">-</td>';
                attchment=false;
                $('#domodjuxt').hide();   
              }
              }
              else{
                reply_stat=false;
              }
              
              row+='</tr>';
              $('#status_table').append(row);
              
              if (stat=="R"){  
              $('#no_reply_tab').hide();
              $('#hist').show();
              document.getElementById("hist").className = "nav-link active";
              document.getElementById("history").className = "container-fluid tab-pane active table responsive ";
              document.getElementById("det").className = "nav-link";
              document.getElementById("details").className = "container-fluid tab-pane ";
            }
            else if (stat=="D"){
              document.getElementById("det").className = "nav-link active";
              document.getElementById("details").className = "container-fluid tab-pane active table responsive ";
              document.getElementById("hist").className = "nav-link";
              document.getElementById("history").className = "container-fluid tab-pane ";
              $('#no_reply_tab').hide();
              $('#hist').show();
              if (reply_stat == false){
                $('#no_reply_tab').show();
                $('#hist').hide();
                document.getElementById("hist").className = "nav-link disabled";
              document.getElementById("history").className = "container-fluid tab-pane disabled";
              }
              else{
                if (attchment==false){
                  $('#domodjuxt').hide();
                }
              }
            }
            reply_date = reply_details['date_of_reply']
            let str1 = 'My Reply (Replied on:- ' + String(reply_date)+')';
            document.getElementById('setreplydata').innerHTML = str1;
            letter_no = do_details.do_letter_no;
            letter_date = do_details.do_letter_date;
            let str = 'Letter No.-' + String(letter_no) + '\t Date:- ' + String(letter_date);
            document.getElementById('setdodata').innerHTML = str;
            }
            });
          
           
          
      }

</script>

<!-- <script>
  function details1(upload_id, reply_id, clicktype){
    console.log(upload_id, reply_id, clicktype)
    var reply=true;
    $('#piframetest').show();
    $('#iframetest').show();
    $('#aiframetest').show();
    data = {
          'upload_id': upload_id,
          'reply_id' : reply_id
        }
    $.ajax({
        url: "{% url 'do_details_ajax' %}",
        method: "GET",
        dataType: "JSON",
        data: data,
        success: function (response) {
          do_details = response.elements;
          reply_details = response.status;
          console.log(do_details,reply_details)
          if(do_details['do_text'] == null)
              {
                $('#piframetest').hide();
                $('#iframetest').show();
                $('#aiframetest').show();
                file = "/media/" + do_details['do_path'];
                $('#iframetest').attr('src', file);
                $('#aiframetest').attr('href', file);
              }
          else{
              file = "/do_pdf_create/" + do_details['id'];
                $('#piframetest').hide();
                $('#iframetest').show();
                $('#aiframetest').show();
                $('#iframetest').attr('src', file);
                $('#aiframetest').attr('href', file);
            }

        }
      });
           
    console.log("till here ok", data)

  }
</script> -->

{% endblock %}