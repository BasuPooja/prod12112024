{% extends 'base.html' %} 
{% block content %}
{% load static %}

<head>
    <link rel="stylesheet" type="text/css" media="screen" href="{% static '/css/forms_common.css' %}">  
    <script type="text/javascript">
        $(".sidebar").addClass('close');
      </script>
</head>

<body>
    <h3 class="report_heading">Inspections Forwarded by Me</h3> 
    <br>
   
    <div class="container" style="overflow-x: auto;">
        <div class="inpt-container" id="container1" style="padding-bottom: 10px;" >
            <div class="row" style="text-align: left; margin-left: 2em;" >
                <div class="col">
                    <label for="Zone" class="lbl-caption">Rly./Org. Wise</label>
                    <select class="form-control" name="rly_id" id="rly_id" class="custom-select" data-placeholder="Select zone.." style="max-width:100%;height:2em;">
                        <option value="" selected>All</option>
                        {% for z in zone %}
                        <option value="{{z}}">{{z}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col">
                    <label for="division" class="lbl-caption">Div./Unit Wise</label>
                    <select class="form-control" name="div_id" id="div_id" class="custom-select" data-placeholder="Select division.." style="max-width:100%;;height:2em">
                        <option value="" selected>All</option>
                        {% for d in division %}
                        <option value="{{d.location_code}}">{{d.location_code}}-{{d.location_type}}</option>
                        {% endfor %}
                    </select>  
                </div>
                <div class="col">
                    <label for="Ofc" class="lbl-caption">Insp. Officer</label>
                    <select class="form-control" name="ofc_id" id="ofc_id" class="custom-select" data-placeholder="Select officer.." style="max-width:100%;height:2em;">
                        <option value="" selected>All</option>
                        {% for z in officr %}
                        <option value="{{z}}">{{z}}</option>
                        {% endfor %}
                    </select>
                </div>
                <!-- <div class="col">
                    <label for="department" class="lbl-caption">Department Wise</label>
                    <select class="form-control" name="dept_id" id="dept_id" class="custom-select" data-placeholder="Select department.." style="max-width:100%;;height:2em">
                        <option value="" selected>All</option>
                        {% for d in dept %}
                        <option value="{{d}}">{{d}}</option>
                        {% endfor %}
                    </select> 
                </div> -->
                <div class="col">
                    <label style="width:10em" class="lbl-caption">Date Range</label>
                    <label id="reportrange" style="width:15em;background: #fff; cursor: pointer;border: 1px solid #ccc;height:2em">
                    <i class="fa fa-calendar" style="margin-left:10px"></i>
                    <span id="dateid"></span> 
                    <i class="fa fa-caret-down"></i>
                    </label>
                </div>
                <div class="col">
                    <div class="btn-toolbar" role="toolbar" style="margin-top:30px;">
                        <div class="btn-group mr-2" role="group" >
                            <button type="button" id="submit_filter" class="btn btn-warning btn-sm" onclick="compliance_filterdata(this);">Continue</button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="compliance_alterdata();">Reset</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <table id="tableshow" class="table table-striped table-bordered table-data" cellspacing="0">
                <thead style="background-color:black; color:white">
                    <tr style="text-align:left">
                        <th>S.No.</th>
                        <th>Insp. Date</th>
                        <th>Insp. Note No</th>
                        <th>Insp. Title</th>
                        <th>Insp. Officer</th>
                        <th>Rly./Org.</th>
                        <th>Div. /Unit</th>
                        <th>View</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for i in listgrid %}
                    <tr style="text-align:left">
                        <td width="5%">{{forloop.counter}}</td>
                        <td width="10%">{{i.inspected_on}}</td>
                        <td width="10%">{{i.inspection_note_no}}</td>
                        <td width="45%"><a class="js-btn-tooltip" data-toggle="tooltip" data-placement="top" title='{{i.inspection_title}}'>{{i.inspection_title|truncatechars:100}}</a></td>
                        <td width="10%">{{i.inspection_officer}}</td>
                        <td style="width:5%">{% for z in i.zone %}<p>{{z}}</p>{% endfor %}</td>
                        <td style="width:5%">{% for z in i.div %}<p>{{z}}</p>{% endfor %}</td>
                        <td style="width:5%">
                            <a type="button"  class="btn btn-outline-primary btn-sm " href="{% url 'inspectionReportHtml' i.inspection_no %}"  id=/{{i.inspection_no}} target="blank" onclick="viewdate(this)"><i class="far fa-file-alt"></i></a>
                        </td>
                        <td style="width:5%">
                            <a type="button"  class="btn btn-outline-primary btn-sm " href="{% url 'compliance_forward' i.inspection_no %}?phase=1"  id=/{{i.inspection_no}} target="blank" onclick="viewdate(this)"><i class="far fa-edit"></i></a>
                        </td>
                    </tr>
                {% endfor %} 
                {% for i in phase2 %}
                    <tr style="text-align:left">
                        <td style="width:5%">{{i.sr_no}}</td>
                        <td style="width:10%">{{i.eitemid__einspno__inspected_on | date:'d/m/y'}}</td>
                        <td style="width:10%">{{i.eitemid__einspno__inspection_note_no}}</td>
                        <td style="width:45%;"><a class="js-btn-tooltip"  data-toggle="tooltip" data-placement="top" title='{{i.eitemid__einspno__inspection_title}}'>{{i.eitemid__einspno__inspection_title|truncatechars:100}}</a></td>
                        <td style="width:10%">{{i.eitemid__einspno__designation__designation}}</td>
                        <td style="width:5%">{{i.eitemid__einspno__rly_id_id__location_code}}</td>
                        <td style="width:5%">{{i.eitemid__einspno__div_id_id__location_code}}</td>
                        <td style="width:5%">
                            <a type="button"  class="btn btn-outline-primary btn-sm " href="{% url 'pdfDetails' %}?id={{i.eitemid__einspno}}"  id=/{{i.eitemid__einspno}} target="_blank"><i class="far fa-file-alt"></i></a>
                        </td>
                        <td style="width:5%">
                            <a type="button"  class="btn btn-outline-primary btn-sm " href="{% url 'compliance_forward' i.eitemid__einspno %}?phase=2"  id=/{{i.eitemid__einspno}} target="blank" ><i class="far fa-edit"></i></a>
                        </td>
                    </tr>
                {% endfor %} 
                </tbody>
            </table>
        </div>
        
    </div>
</body>
<script>
      $( document ).ready
  (
    function() 
    {
      $('#tableshow').DataTable({
                    "language":{
                        "search": "Keyword search:"
                    },
                    "aoColumns": [
            null,
            { "sType": "date-uk" },
            null,
            null,
            null,
            null,
            null,
            null,
            null
        ]
    });
    $('#container1').show();
        $('#tableshow').show();
        var start = moment().subtract(30, 'days');
        var end = moment();
        function cb(start, end) 
        {
            // $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
            $('#reportrange span').html(start.format('D/M/YY') + ' to ' + end.format('D/M/YY'));
        }
        $('#reportrange').daterangepicker
        ({
            startDate: start,
            endDate: end,
            maxDate: new Date(),
            // ranges: 
            // {
            //     'Today': [moment(), moment()],
            //     'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
            //     'Last 7 Days': [moment().subtract(6, 'days'), moment()],
            //     'Last 30 Days': [moment().subtract(29, 'days'), moment()],
            //     'This Month': [moment().startOf('month'), moment().endOf('month')],
            //     'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            // }
        },cb);
        // cb(start, end);
})
    
</script>

<script>
        function compliance_filterdata(e)
    {
        var table = $('#tableshow').DataTable(    
        );
        table.destroy();
        $('#tableshow').hide();
        var str=e.id;
        var data={}
        if(str=='submit_filter')
        {
            var div_id=$('#div_id').val();
            var rly_id=$('#rly_id').val();
            var ofc_id=$('#ofc_id').val();
            // var dept_id=$('#dept_id').val();
            var date_id=document.getElementById('dateid').innerHTML
            if (date_id==''){
                var start = moment().subtract(50, 'years');
                var end = moment();
            }
            else{
                var start=$('#reportrange').data('daterangepicker').startDate;
                var end=$('#reportrange').data('daterangepicker').endDate;
            }
            
            var startDate = new Date(start);
            startDate= startDate.getFullYear()+ '-' + (startDate.getMonth()+1) + '-' + startDate.getDate()
            var endDate = new Date(end);
            endDate=endDate.getFullYear() + '-' +(endDate.getMonth()+1) + '-' + endDate.getDate()
            data=
            {
                'div_id':div_id,
                'rly_id':rly_id,
                'ofc_id':ofc_id,
                'startDate':startDate,
                'endDate': endDate,
                // 'dept_id':dept_id,
                'str':'forwarded_all'
            }
            console.log(data)
        }
        $.ajax
        ({
            url: "{% url 'compliance_filterdata1' %}",
            method: "GET",
            dataType: "JSON",
            async: false,
            data: data,
            success: function (response) 
            {
                let filterdata = response.inspect_details;
        
                let row = "";
                let head = 
                    `<thead style="background-color:black; color:white">
                        <tr align=left>
                            <th>S.No.</th>
                            <th>Insp. Date</th>
                            <th>Insp. Note No</th>
                            <th>Insp. Title</th>
                            <th>Insp. Officer</th>
                            <th>Rly./Org.</th>
                            <th>Div. /Unit</th>
                            <th>View</th>
                            <th>Status</th>
                        </tr>
                    </thead>`;
                // <td>${filterdata[i]['viewed_on']}</td>
                for (let i = 0; i < filterdata.length; i++) 
                {
                    var zns=filterdata[i]['zone'];
                    var divs=filterdata[i]['div'];
                    var railway_zone='';
                    for (let z = 0; z < zns.length; z++) {
                        railway_zone+=`<p>`+zns[z]+`</p>`;
                    }
                    var divisions='';
                    for (let z = 0; z < divs.length; z++) {
                        divisions+=`<p>`+divs[z]+`</p>`;
                    }

                    row += "<tr align=left>";
                    row += `<td width=5%>${filterdata[i]['sr_no']}</td>
                    <td width=10%>${filterdata[i]['inspected_on']}</td>
                    <td width=10%>${filterdata[i]['inspection_note_no']}</td>
                    <td width=45%><a class="js-btn-tooltip" data-toggle="tooltip" data-placement="top" title='${filterdata[i]['inspection_title']}'>${filterdata[i]['inspection_title'].slice(0, 100)}..</a></td>
                    <td width=15%>${filterdata[i]['inspection_officer']}</td>
                    <td style="width:5%">`+railway_zone+`</td>
                    <td style="width:5%">`+divisions+`</td>`
                    row+=`<td style="width:5%">
                        <a type="button"  class="btn btn-outline-primary btn-sm" href="/inspectionReportHtml/${filterdata[i]['inspection_no']}" id=/{{i.inspection_no}} target="blank" onclick="viewdate(this)"><i class="far fa-file-alt"></i></a>
                        </td>
                        <td style="width:5%">
                            <a type="button"  class="btn btn-outline-primary btn-sm " href="/compliance_forward/${filterdata[i]['inspection_no']}/phase=1"  id=/{{i.inspection_no}} target="blank" onclick="viewdate(this)"><i class="far fa-edit"></i></a>
                        </td>`
                    row += "</tr>";                    
                }
                let phase2_data = response.phase2;
                for (let i = filterdata.length; i < phase2_data.length; i++) 
                {
                    row += "<tr align=left>";
                    row += `<td width=5%>${i+1}</td><td style="display:none;">${phase2_data[i]['eitemid__einspno']}</td>
                    <td width=10%>${phase2_data[i]['eitemid__einspno__inspected_on']}</td>
                    <td width=10% >${phase2_data[i]['eitemid__einspno__inspection_note_no']}</td>
                    <td width=45%>${phase2_data[i]['eitemid__einspno__inspection_title'].slice(0, 100)}..</td>
                    <td width=15%>${phase2_data[i]['eitemid__einspno__designation__designation']}</td>
                    <td style="width:5%">${phase2_data[i]['eitemid__einspno__rly_id_id__location_code']}</td>
                    <td style="width:5%">${phase2_data[i]['eitemid__einspno__div_id_id__location_code']}</td>`

                    row+=`
                    <td style="width:5%">
                            <a type="button"  class="btn btn-outline-primary btn-sm " href="/pdfDetails/?id=${phase2_data[i]['eitemid__einspno']}"  id=/${phase2_data[i]['eitemid__einspno']} target="_blank"><i class="far fa-file-alt"></i></a>
                        </td>
                        <td style="width:5%">
                            <a type="button"  class="btn btn-outline-primary btn-sm " href="/compliance_forward/${phase2_data[i]['eitemid__einspno']}/?phase=2"  id=/${phase2_data[i]['eitemid__einspno']} target="blank" ><i class="far fa-edit"></i></a>
                        </td>
                        `
                    row += "</tr>";                    
                }
                $('#tableshow thead').remove();
                $('#tableshow tr').remove();
                $('#tableshow').append(head);
                $('#tableshow tbody').append(row);
                $('#tableshow').show();
                $('#tableshow').DataTable({
                    "language":{
                        "search": "Keyword search:"
                    },
                    "aoColumns": [
            null,
            { "sType": "date-uk" },
            null,
            null,
            null,
            null,
            null,
            null,
            null
        ]
                });
            }
        })
    }


    function compliance_alterdata()
    {
        window.location.reload()
    }

</script>
<script>
      jQuery.extend( jQuery.fn.dataTableExt.oSort, {
"date-uk-pre": function ( a ) {
    var ukDatea = a.split('/');
    return (ukDatea[2] + ukDatea[1] + ukDatea[0]) * 1;
},

"date-uk-asc": function ( a, b ) {
    return ((a < b) ? -1 : ((a > b) ? 1 : 0));
},

"date-uk-desc": function ( a, b ) {
    return ((a < b) ? 1 : ((a > b) ? -1 : 0));
}
} );
</script>
{% endblock %}