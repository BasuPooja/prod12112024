{% extends 'base.html' %}
{% block content %}
{% load static %}



<link rel="stylesheet" type="text/css" media="screen" href="{% static '/css/forms_common.css' %}">

<script type="text/javascript">
  $(".sidebar").addClass('close');
</script>

<body>
  <h3 class="report_heading">My Draft Inspection Notes</h3>
  <br>
  <div class="container" id="container1">
    {% if messages %}
    {% for message in messages %}
    {% if message.tags == 'success' %}
    <div class="alert alert-success">
      <strong>Success </strong>{{ message }}
    </div>
    {% elif message.tags == 'error' %}
    <div class="alert alert-danger">
      <strong>Error </strong>{{ message }}
    </div>
    {% elif message.tags == 'info' %}
    <div class="alert alert-info">
      <strong>Info </strong>{{ message }}
    </div>
    {% else %}

    {% endif %}


    {% endfor %}
    {% endif %}
  </div>

  <div class="container">
    <div class="inpt-container" id="container1" style="padding-bottom: 10px;">
      <div class="row" style="text-align: left; margin-left: 2em;">
        <div class="col">
          <label style="width:10em" class="lbl-caption">Date Range</label>
          <input id="date_range" class="form-control" name="date_range" autocomplete="off"
            placeholder="dd/mm/yy - dd/mm/yy">
        </div>
        <div class="col">
          <label for="Zone" class="lbl-caption">Rly./Org. Wise</label>
          <select class="form-control" name="rly_id" id="rly_id" class="custom-select" data-placeholder="Select zone.."
            style="max-width:100%;height:2em;">
            <option value="" selected>All</option>
            {% for z in zone %}
              
              <option value="{{z}}">{{z}}</option>
              
            {% endfor %}
          </select>
        </div>
        <div class="col">
          <label for="division" class="lbl-caption">Div./Unit Wise</label>
          <select class="form-control" name="div_id" id="div_id" class="custom-select"
            data-placeholder="Select division.." style="max-width:100%;;height:2em">
            <option value="" >All</option>
            {% for d in division %}
              
              <option value="{{d.location_code}}">{{d.location_code}}</option>
            {% endfor %}
          </select>
        </div>
        <!-- <div class="col">
                <label for="department" class="lbl-caption">Department Wise</label>
                <select class="form-control" name="dept_id" id="dept_id" class="custom-select" data-placeholder="Select department.." style="max-width:100%;;height:2em">
                    <option value="" selected>All</option>
                    {% for d in dept %}
                    <option value="{{d}}">{{d}}</option>
                    {% endfor %}
                </select> REC'D REPLY
            </div> -->
      
        <div class="col">
          <div class="btn-toolbar" role="toolbar" style="margin-top:30px;">
            <div class="btn-group mr-2" role="group">
              <button type="button" id="submit_filter" class="btn btn-warning btn-sm"
                onclick="draft_filterdata(this);" hidden>Continue</button>

                <button type="button"  class="btn btn-warning btn-sm"
                onclick="search_data();">Continue</button>
              <button type="button" class="btn btn-secondary btn-sm" onclick="draft_alterdata();">Reset</button>
              <a type="button" class="btn btn-danger btn-sm"  target="_blank" href="{% url 'draft_inspection_form_pdf'%}" hidden><i class="fa-solid fa-file-pdf"></i> PDF</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container" style="font-family:'Lato', sans-serif">
    <table id="mytable" class="table table-striped table-bordered table-sm table-data">
      <thead style="background-color: #343a40;white-space: nowrap; color:white;text-align: left;">
        <tr>
          <th>S.No.</th>
          <th>Insp. Date</th>
          <th>Inspection Type</th>
          <th>Insp. Title</th>
          <th>Rly./Org.</th>
          <th>Div./Unit</th>
          <!-- <th>Department</th>
            <th>Location</th>
             -->

          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for i in list1 %}
        <tr>
          <td>{{forloop.counter}}</td>

          {% if i.inspected_on %}
          <td>{{i.inspected_on|date:"d/m/y"}}</td>
          <td>General</td>
          {% else %}
          <td style="white-space: nowrap;">NA</td>
          {% endif %}

          <td><a class="js-btn-tooltip" data-toggle="tooltip" data-placement="top" title='{{i.inspection_title}}'>
              {{i.inspection_title|truncatechars:150}}
            </a>
          </td>


          <td>

            {% for j in i.location_item %}
            {% if j.type == 'HQ' %}
            <span>{{j.item}}<br></span>
            {% endif %}
            {% endfor %}

          </td>

          <td>

            {% for j in i.location_item %}
            {% if j.type == 'DIV' %}
            <span>{{j.item}}<br></span>
            {% endif %}
            {% endfor %}
            </ul>
          </td>

          <!-- <td>
            
                {% for j in i.location_item %}
                {% if j.type == 'DPT' %}
                <span >{{j.item}}<br></span>
                {% endif %}
                {% endfor %}
           
          </td> -->

          <!-- <td>
                
                    {% for j in i.location_item %}
                    {% if j.type == 'LOC' %}
                    <span >{{j.item}}<br></span>
                    {% endif %}
                    {% endfor %}
                
           </td> -->






          <td style="white-space: nowrap;">
            <button type="button" class="btn btn-outline-primary btn-sm" id="{{i.inspection_no}}"
              onclick="open_inspection(this,'phase1')"><i class="far fa-edit"></i></button> &nbsp;
            <button type="button" class="btn btn-outline-danger btn-sm" id="{{i.inspection_no}}"
              onclick="delete_inspection(this,'phase1')"><i class="fas fa-trash-alt"></i></button>
          </td>
        </tr>
        {% endfor %}
        {% for i in dataph2 %}
        <tr>
          <td>{{i.sr_no}}</td>

          {% if i.inspected_on %}
          <td>{{i.inspected_on|date:"d/m/y"}}</td>
          <td>{{i.instypeid__name}}</td>

          {% else %}
          <td style="white-space: nowrap;">NA</td>
          {% endif %}

          <td><a class="js-btn-tooltip" data-toggle="tooltip" data-placement="top" title='{{i.inspection_title}}'>
              {{i.inspection_title|truncatechars:150}}
            </a>
          </td>
          <td>{{i.rly_id_id__location_code}}</td>

          <td>{{i.div_id_id__location_code}}</td>
          <td style="white-space: nowrap;">
            <button type="button" class="btn btn-outline-primary btn-sm" id="{{i.einspno}}" name="{{i.instypeid}}"
              onclick="open_inspection(this,'phase2')"><i class="far fa-edit"></i></button> &nbsp;
              <button type="button" class="btn btn-outline-danger btn-sm"  name="{{i.einspno}}" onclick="pdfDet_delete(this.name);">
                <i class="fas fa-trash-alt"></i>
            </button>
            <!-- <button type="button" class="btn btn-outline-danger btn-sm" id="{{i.einspno}}"
              onclick="delete_inspection(this,'phase2')"><i class="fas fa-trash-alt"></i></button> -->
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    
  </div>

</body>
<script>
  function search_data()
  {
      var div_id = $('#div_id').val();
      var rly_id = $('#rly_id').val();
      var date_range = $('#date_range').val();
      var table = $('#mytable').DataTable();
      if (date_range != '') {
            date_range = date_range.split(' - ');
            let sd = date_range[0].split('/');
            let ed = date_range[1].split('/');
            let sdFormatted = '20' + sd[2] + '-' + sd[1] + '-' + sd[0];
            let edFormatted = '20' + ed[2] + '-' + ed[1] + '-' + ed[0];
            $.fn.dataTable.ext.search.push(
              function(settings, data, dataIndex) {
                var date = data[1]; // Assuming date column is index 1
                var dateFormatted = date;
                if (dateFormatted >= sdFormatted && dateFormatted <= edFormatted) {
                  return true; 
                }
                return false; 
              }
            );
          }
      
      if( rly_id == '' && div_id == '' && date_range == '')
      {
          alert('Select atleast one to search');
          return false;
      }
      else if( rly_id != '' && div_id == '')
      {
        table.column(4).search(rly_id).draw();
          return false;
      }
      else if( rly_id == '' && div_id != '')
      {
          table.column(5).search(div_id).draw();
          return false;
      }
      else if( rly_id != '' && div_id != '')
      {
          table.column(4).search(rly_id)
          table.column(5).search(div_id).draw();
          return false;
      }
      else{
        table.draw();
      }
    }
  $(document).ready(function () {
    $("#submit_filter").click();
  });
  jQuery.extend( jQuery.fn.dataTableExt.oSort, {
"date-uk-pre": function ( a ) {
    var ukDatea = a.split('/');
    return (ukDatea[2] + ukDatea[1] + ukDatea[0]) * 1;
},

"date-uk-asc": function ( a, b ) {
    return ((a < b) ? -1 : ((a > b) ? 1 : 0));
},

"date-uk-desc": function ( a, b ) {
    return ((a < b) ? 1 : ((a > b) ? -1 : 0));
}
} );


  function open_inspection(e,phase) {
    var ins_id = e.id;
    if(phase=='phase1')
    window.open("/create_inspection_form?flag=0&ins_id=" + ins_id)
    if (phase=='phase2'){
      instypeid=e.name;
      einspno=e.id;
      window.open("{% url 'showMenu' %}" + "?id=" + instypeid+"&inspectionId="+einspno);
    }
  }

  function delete_inspection(el) {
    const insp_id = el.id
    var retVal = confirm("Do you want to delete this record ?");
    if (retVal == true) {
      document.write("User wants to continue!");
      $.ajax({
        url: '{% url "delete_inspection_ajax" %}',
        method: 'GET',
        dataType: 'JSON',
        async: false,
        data: { insp_id },
        success: function (res) {
          alert('Inspection deleted! successfully')
          window.location.reload()
        }
      })
    } else {
      window.location.reload()
      return false;
    }

  }
  function pdfDet(id)
  {
    window.open("{% url 'pdfDetails' %}"+"?id="+id);
  }

  $(document).ready(function () {

    $('.js-btn-tooltip').tooltip();

    $('.js-btn-tooltip--custom-alt').tooltip({
      customClass: 'tooltip-custom-alt'
    });

    var start = moment().subtract(29, 'days');
    var end = moment();
    function cb(start, end) {
      // $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
      $('#reportrange span').html(start.format('D/M/YY') + ' to ' + end.format('D/M/YY'));
    }
    $('#reportrange').daterangepicker
      ({
        startDate: start,
        endDate: end,
        maxDate: new Date(),
        ranges:
        {
          'Today': [moment(), moment()],
          'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
          'Last 7 Days': [moment().subtract(6, 'days'), moment()],
          'Last 30 Days': [moment().subtract(29, 'days'), moment()],
          'This Month': [moment().startOf('month'), moment().endOf('month')],
          'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        }
      }, cb);

  });

</script>
<script>
  function draft_filterdata(e) {
    var table = $('#mytable').DataTable();
    table.destroy();
    $('#mytable').hide();
    var str = e.id;
    var data = {}
    if (str == 'submit_filter') {
      var div_id = $('#div_id').val();
      var rly_id = $('#rly_id').val();
      var date_range = $('#date_range').val();
      data =
      {
        'div_id': div_id,
        'rly_id': rly_id,
        'date_range': date_range,
        'str': 'draft search'
      }
    }
    $.ajax
      ({
        url: "{% url 'draft_filterdata_ajax_inspection' %}",
        method: "GET",
        dataType: "JSON",
        async: false,
        data: data,
        success: function (response) {
 
          let filterdata = response.inspect_details;
          let row = "";
          let head =
            `<thead style="background-color:black; color:white">
                        <tr align=left>
                            <th>S.No.</th>
                            <th style="display:none;"></th>
                            <th>Insp. Date</th>
                            <th>Insp. Title</th>
                            <th>Rly./Org.</th>
                            <th>Div./Unit</th>
                            <th>Action</th>
                        </tr>
                    </thead>`;
         
                    // console.log(filterdata)
          for (let i = 0; i < filterdata.length; i++) 
          {
            let index = parseInt(i) + 1
            let hq = ''
            let loc = ''
            let dept = ''
            let div = ''
            
            for (y in filterdata[i]['location_item']) {
             
              
              if (filterdata[i]['location_item'][y]['type'] == 'HQ') {
                hq += '<span>' + filterdata[i]['location_item'][y]['item'] + '<br></span>'
              }
              else if (filterdata[i]['location_item'][y]['type'] == 'LOC') {
                loc += '<span>' + filterdata[i]['location_item'][y]['item'] + '<br></span>'
              }
              else if (filterdata[i]['location_item'][y]['type'] == 'DIV') {
                div += '<span>' + filterdata[i]['location_item'][y]['item'] + '<br></span>'
              }
              else if (filterdata[i]['location_item'][y]['type'] == 'DPT') {
                dept += '<span>' + filterdata[i]['location_item'][y]['item'] + '<br></span>'
              }
            }
              row += "<tr align=left>";
              row += `<td width=5%>${i + 1}</td>
              <td style="display:none;">${filterdata[i]['inspected_on']}</td>
                    <td width=10%>${formatDate(filterdata[i]['inspected_on']) }</td>
                    <td width=60%><a class="js-btn-tooltip" data-toggle="tooltip" data-placement="top" title='${filterdata[i]['inspection_title']}'>${filterdata[i]['inspection_title'].slice(0, 150)}..</a></td>
                    <td width=8%>${hq}</td>
                    
                    <td width=7%>${div}</td>
                    <td style="width:10%; text-align:left">
                        
                        <button type="button" class="btn btn-outline-primary btn-sm" id="${filterdata[i]['inspection_no']}"
              onclick="open_inspection(this,'phase1')"><i class="far fa-edit"></i></button> &nbsp;
            <button type="button" class="btn btn-outline-danger btn-sm" id="${filterdata[i]['inspection_no']}"
              onclick="delete_inspection(this)"><i class="fas fa-trash-alt"></i></button>
                    </td>`;
              row += "</tr>";
            }
            // console.log(row)
            
            
            let phase2data = response.phase2;
            
            for (let i = 0; i < phase2data.length; i++) {
            
              row += "<tr align=left>";
              row += `<td width=5%>${i + 1}</td>
                    <td style="display:none;">${phase2data[i]['inspected_on']}</td>
                    <td width=10%>${formatDate(phase2data[i]['inspected_on'])}</td>
                    <td width=60%><a class="js-btn-tooltip" data-toggle="tooltip" data-placement="top" title='${phase2data[i]['inspection_title']}'>${phase2data[i]['inspection_title'].slice(0, 150)}..</a></td><td width=8%>`
                    

                    console.table(phase2data[i]['einsprly'])
                 for(j in phase2data[i]['einsprly'])
                 {
                  row += phase2data[i]['einsprly'][j]['location_code']+'<br>';
                 }
                 console.table(phase2data[i]['einspdiv'])
                 row += `</td><td width=7%>`;
                  for(j in phase2data[i]['einspdiv'])
                 {
                  row += phase2data[i]['einspdiv'][j]['location_code']+'<br>';
                 }
                 row += `</td>`;
                      
                    
                    row += `<td style="width:10%; text-align:left">
                      <button type="button" class="btn btn-outline-primary btn-sm" id="${phase2data[i]['einspno']}" name="${phase2data[i]['instypeid_id']}"
                        onclick="open_inspection(this,'phase2')"><i class="far fa-edit"></i></button> &nbsp;
                      <button type="button" class="btn btn-outline-danger btn-sm"  name="${phase2data[i]['einspno']}" onclick="pdfDet_delete(this.name);">
                          <i class="fas fa-trash-alt"></i>
                      </button>
                    </td>`;
              row += "</tr>";
            }
           
            $('#mytable thead').remove();
            $('#mytable tr').remove();
            $('#mytable').append(head);
            $('#mytable tbody').append(row);
            $('#mytable').show();
            $('#mytable').DataTable({
              "language": {
                "search": "Keyword search:"
              },
              "aaSorting": [[ 2, "desc" ]] ,// Sort by first column descending
              "aoColumns": [
                    null,
                    null,
                    { "sType": "date-uk" },
                    null,
                    null,
                    null,
                    null
                ],
                "fnRowCallback" : function(nRow, aData, iDisplayIndex){
                $("td:first", nRow).html(iDisplayIndex +1);
               return nRow;
            }
            });
          }
        })
  }

  $('#rly_id').change(function () {
    var rly_id = $('#rly_id').val();
    data =
    {
      'rly_id': rly_id,
      'str': 'filter',
    }
    $.ajax
      ({
        url: "{% url 'draft_filterdata_ajax_inspection' %}",
        method: "GET",
        dataType: "JSON",
        async: false,
        data: data,
        success: function (response) {
          div = response.div;
          $('#div_id').empty();
          $('#div_id').append(`<option value="">All</option>`);
          for (let i = 0; i < div.length; i++) {
            $('#div_id').append
              (
                `<option value="${div[i]}">
                        ${div[i]}
                        </option>`);
          }
        }
      })
  });

  function draft_alterdata() {
    window.location.href = '{% url "draft_inspection_form" %}'
  }


  // $("#rly_id").select2();
  // $("#div_id").select2();
  // $("#dept_id").select2();


  $('input[name="date_range"]').daterangepicker({
    autoUpdateInput: false,
    autoApply: true,
    maxDate: new Date(),
    locale: {
      cancelLabel: 'Clear'
    }
  });

  $('input[name="date_range"]').on('apply.daterangepicker', function (ev, picker) {
    $(this).val(picker.startDate.format('DD/MM/YY') + ' - ' + picker.endDate.format('DD/MM/YY'));
    $('.applyButtonClasses').click()


  });

  $('input[name="date_range"]').on('cancel.daterangepicker', function (ev, picker) {
    $(this).val('');
  });






  function formatDate(date) {
    var d = new Date(date),
      month = '' + (d.getMonth() + 1),
      day = '' + d.getDate(),
      year = d.getFullYear();

    if (month.length < 2)
      month = '0' + month;
    if (day.length < 2)
      day = '0' + day;
    let newyear = String(year).slice(2, 5)
    return [day, month, newyear].join('/');
  }

function pdfDet_delete(einspno)
{
  
  var retVal = confirm("Do you want to delete this record ?");
    if (retVal == true) {
      document.write("User wants to continue!");
      $.ajax({
        url: '{% url "delete_inspection_phase2_ajax" %}',
        method: 'GET',
        dataType: 'JSON',
        async: false,
        data: { einspno },
        success: function (res) {
          alert('Inspection deleted! successfully')
          window.location.reload()
        }
      })
    } else {
      window.location.reload()
      return false;
    }

}

</script>
{% endblock %}