{% extends 'base.html' %} 
{% block content %}
{% load static %}

<head>
  <link rel="stylesheet" type="text/css" href="{% static '/css/forms_common.css' %}" />   
  <script type="text/javascript">
    $(".sidebar").addClass('close');
  </script>  
</head>
  
<body>
  <h3 class="report_heading" style="color:#343a40!important;">Aproval for deleting Inspections </h3>
 
  <div class="container">
      {% if messages %}
          {% for message in messages %}
              {% if message.tags == 'success' %}
                <div class="alert alert-remove alert-success alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
              {% elif message.tags == 'error' %}
                
                <div class="alert alert-remove alert-danger alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
              {% elif message.tags == 'info' %}
                
                <div class="alert alert-remove alert-info alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
              {% else %}
              
              {% endif %}
                  
          {% endfor %}
      {% endif %}
  </div>

  <br>
    
  <div class="container">
      <div class="  inpt-container" id="container1" style="padding-bottom:10px;">
    
          <form  method="POST" class="d-inline " >     
          {% csrf_token %}
            
            <div class="row" id="row1" style="font-family: 'Lato', sans-serif;font-size: 1em; margin-left: 2em;">

              <div  class="col" >
                <label for="location" class="lbl-caption">Date Range</label>
                <input id="date_range" class="form-control" name="date_range" autocomplete="off" placeholder="dd/mm/yy - dd/mm/yy" >
              </div>
              <div class="col"  >
                  <label for="Zone" class="lbl-caption">Rly./Org. </label>
                  <select class="form-control" id="zone" data-placeholder="Rly./Org Wise..." name="zone" class="custom-select"
                      multiple ><span style="color:red;font-weight:bold">*</span>
                      <option value="" disabled>select</option>
                      {% for z in Zone %}
                      <option value="{{z}}">{{z}}</option>
                      {% endfor %}

                  </select>
              </div>
              <div class="col">
                  <label for="division " class="lbl-caption" >Division/Unit</label>
                  <select class="form-control" id="division" data-placeholder="Div./Unit Wise..." name="division" class="custom-select" style="max-width:100%;"
                  multiple><span style="color:red;font-weight:bold">*</span>
              
                          <option value="" disabled>select</option>
                          {% for d in division %}
                              <option value="{{d.location_code}}">{{d.location_code}}</option>
                              {% endfor %}
                      </select>
                  
              </div>
              
              <div class = "col">
                <label for="designation " class="lbl-caption" >Designation</label>
                <select class="form-control" id="designation" data-placeholder="Designation wise..." name="designation" multiple>
                  <span style="color:red;font-weight:bold">*</span>
              
                          <option value="" disabled>select</option>
                          {% for k in desig %}
                              <option value="{{ k }}">{{ k }}</option>
                          {% endfor %}
                </select>
              </div>
              <div class="col" hidden>
                <label for="division" class="lbl-caption">Department</label>
                <select class="form-control" id="department"  name="department" class="custom-select" style="max-width:100%;" multiple>
              
                        <option value="" disabled>select</option>
                        {% for d in department %}
                        <option value="{{d.department_name}}">{{d.department_name}}</option>
                        {% endfor %}            
                </select>
              </div>
              <div  class="col" >          
                <div class="btn-toolbar" role="toolbar" >
                  <div class="btn-group mr-2" role="group" style="margin-top:30px;" >

                    <button  type="button"  name="zone_loc_submit" class="btn btn-warning btn-sm" id="insp_submit" onclick="getSearchValue()">Continue</button>
                    <button  type="button" class="btn btn-secondary btn-sm" id="insp_clear" onclick="refreshPage()">Reset</button>
                    <a type="button" class="btn btn-danger btn-sm"  target="_blank" href="{% url 'created_checklist_pdf'%}" hidden><i class="fa-solid fa-file-pdf"></i> PDF</a>
                  </div>
                </div>
              </div>
            </div>
          </form>
      </div>
  </div>
      
 
 <div class="container" style="font-family:'Lato', sans-serif; overflow-x: auto;"></div>
      <table class="table table-striped table-bordered table-sm table-data" id="instituteTable" >
          <thead
              style="background-color: #343a40;white-space: nowrap; color:white;text-align: left;">
              <th style="width:5%">S.No.</th>
              <th style="display:none;"></th>
              <th style="width:10%" >Request Date </th>
              <th style="width:10%" >Insp. Note No.</th>
              <th style="width:10%" >Insp. Type</th>
              <th style="width:35%" >Insp. Title</th>
              <th  style="width:5%">Rly./Org.</th>
              <th  style="width:5%">Div./Unit</th>
              <th style="width:30%" >Action</th>  
          </thead>
      <tbody>
            {% for i in phase2 %}
                <tr>
                  <td style="width:5%">{{ forloop.counter }}</td>
                  <td style="display:none;">{{i.inspected_on| date:'Y-m-d'}}</td>
                  <td>{{i.inspected_on | date:'d/m/y' }}</td>
                  <td>{{i.inspection_note_no}}</td>
                  <td>{{i.instypeid__name}}</td>
                  <td>{{i.inspection_title}}</td>
                  <td>
                    {% for j in i.einsprly %}
                          <span >{{j.location_code}}<br></span>
                        {% endfor %}
                  </td>
                  <td> {% for j in i.einspdiv %}
                    <span >{{j.location_code}}<br></span>
                  {% endfor %}
                  </td>
                  <td>
                      <button type="button" class="btn btn-primary" >View</button>
                      <button type="button" class="btn btn-success">Approve</button>
                      <button type="button" class="btn btn-danger">Reject</button>
  
                  </td>
                  
                </tr>
            {% endfor %}
  
            {% for g in mydata %}
              <tr>
                 
                <td style="width:5%">{{ g.sr_no }}</td>
                <td style="display:none;">{{g.inspected_on | date:'Y-m-d'}}</td>
                <td style="width:10%">{{g.inspected_on|date:"d/m/y" }}</td>

                <td style="width:10%">{{ g.inspection_note_no }}</td>
                <td style="width:10%">General</td>
                <td style="width:35%"><a class="js-btn-tooltip" data-toggle="tooltip" data-placement="top" title='{{g.inspection_title}}'>
                  {{g.inspection_title|truncatechars:100}}
                </a>
              </td>

                <td style="width:5%">
                    
                        {% for j in g.location_item %}
                        {% if j.type == 'HQ' %}
                        <span >{{j.item}}<br></span>
                        {% endif %}
                        {% endfor %}
                    
                </td>
                <td style="width:5%">
                   
                        {% for j in g.location_item %}
                        {% if j.type == 'DIV' %}
                            <span >{{j.item}}<br></span>
                        {% endif %}
                        {% endfor %}
                 
                </td>
                <td style="width:30%" >
                    <a type="button" class="btn btn-primary btn-sm"  href="{% url 'inspectionReportHtml' g.inspection_no %}"   target="_blank">View</a>
                    <a type="button" class="btn btn-success btn-sm"  onclick="confirmApproval('{{ g.inspection_no}}','{{ g.inspection_note_no}}')" >Approve</a>
                    <a type="button" class="btn btn-danger btn-sm"  onclick="rejectDeletion('{{ g.inspection_no }}','{{ g.inspection_note_no}}')">Reject</a>
                </td>     
              </tr> 
            {% endfor %}
          </tbody>
  
      </table>
     
  </div>
  <br> 
  
  
  
  </body>   

  
  <script>

function refreshPage() {
            location.reload();
        
    }
 
    $("#zone").select2();
   
           // Read selected option
           $('#rly').click(function(){
             var username = $('#rly option:selected').text();
             var userid = $('#rly').val();
         
            
         
  
           });
   
   $("#division").select2();
   
   $('#division').click(function(){
     var username = $('#div option:selected').text();
     var userid = $('#div').val();
  });
  
   $("#department").select2();
   
   $('#department').click(function(){
     var username = $('#department option:selected').text();
     var userid = $('#department').val();
  });
  
  $("#designation").select2();
   
   $('#designation').click(function(){
     var username = $('#designation option:selected').text();
     var userid = $('#designation').val();
  });
  
  </script>

  <script>
  
  //Pratibha 160223
  $('#zone').change(function() {
  var rly_new=$('#zone').val();
  // alert(rly_new)


  $.ajax({
  type : 'GET',
  url : "{% url 'getdiv_rly' %}",
  dataType : 'json',
  data : {
    'rly_data':JSON.stringify(rly_new),
   
  },
  success : function(response){
    division=response.division;
                $('#division').empty();
                $('#division').append(`<option value="">All</option>`);
                for (let i = 0; i < division.length; i++) {
                $('#division').append(`<option value="${division[i].location_code}">
                  ${division[i].location_code}-${division[i].location_type}
                              </option>`);
                            }
  }
})
})

  
  
     $("#location").select2({
      minimumInputLength: 1,
      language: {
          inputTooShort: function() {
            return 'Search Location';
          }
        },
      tags: [],
      ajax: {
          url: '{% url "autoFetchLocation" %}',
          dataType: 'json',
          type: "GET",
          quietMillis: 50,
          data: function (term) {
              return {
                  last_val: term.term
              };
            
          },
          processResults: function (data) {
            return {
                  results: $.map(data, function (item) {
                    
                      return{
                        text: item.city,
                        
                        id: item.city,
                      }
                  })
              };
            },
          
          
      }
  });

$(document).ready(function(){
  
})


$(function() {

    $('input[name="date_range"]').daterangepicker({
        autoUpdateInput: false,
        autoApply: true,
        maxDate: new Date(),
        locale: {
            cancelLabel: 'Clear'
        }
    });

  $('input[name="date_range"]').on('apply.daterangepicker', function(ev, picker) {
      $(this).val(picker.startDate.format('DD/MM/YY') + ' - ' + picker.endDate.format('DD/MM/YY'));
      $('.applyButtonClasses').click()
     
      
  });

    $('input[name="date_range"]').on('cancel.daterangepicker', function(ev, picker) {
        $(this).val('');
    });

    

});



window.setTimeout(function() {

$(".alert-remove").slideUp(100, function() {
    $(this).remove();
});
}, 2000);



var table = $('#instituteTable').DataTable({
  "language": {
    "search": "Keyword search:"
  },
  "aaSorting": [[ 1, "desc" ]] ,
  "aoColumns": [
            null,
            null,
            { "sType": "date-uk" },
            null,
            null,
            null,
            null,
            null,

        ],
                "fnRowCallback" : function(nRow, aData, iDisplayIndex){
                $("td:first", nRow).html(iDisplayIndex +1);
               return nRow;
            }
});

table.$('tr').tooltip( {
      placement : '',
      html : true
})


function getSearchValue(){
     
     let data1 = {
             zone1: JSON.stringify($('#zone').val()),
             division1: JSON.stringify($('#division').val()),
             department1: JSON.stringify($('#department').val()),
             location1: JSON.stringify($('#location').val()),
             designation1: JSON.stringify($('#designation').val()),
             date_range: $('#date_range').val(),
             csrfmiddlewaretoken: '{{ csrf_token }}'
                 
         }
     
         $.ajax({
           type : 'POST',
           url : "{% url 'getSearchValueAproval_ajax' %}",
           dataType : 'json',
           data : data1,
 
           success : function(res){
       
             
            // table.destroy()
             $('#instituteTable tbody').empty()
             content = ''
             for(i in res.mydata){
               let index = parseInt(i)+1
               let hq = ''
               let loc = ''
               let dept = ''
               let div = '' 
               let desig = ''
 
               for(y in res.mydata[i].location_item){
                 
                 if(res.mydata[i].location_item[y].type == 'HQ'){
                   hq += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
                 }
                 else if (res.mydata[i].location_item[y].type == 'LOC'){
                   loc += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
                 }
                 else if (res.mydata[i].location_item[y].type == 'DIV'){
                   div += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
                 }
                 else if (res.mydata[i].location_item[y].type == 'DEPT'){
                   dept += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
                 }
                 else if (res.mydata[i].location_item[y].type == 'DESIG'){
                   desig += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
                 }
               } 
 
               content += '<tr>'
               content += '<td>'+ index +'</td>'
               content += `<td style="display:none;">${res.mydata[i].inspected_on}</td>`
               content += '<td>'+ formatDate(res.mydata[i].inspected_on) +'</td>'
               content += '<td>'+ res.mydata[i].inspection_note_no +'</td>'
               content += '<td>General</td>'
               content += '<td><a class="js-btn-tooltip" data-toggle="tooltip" data-placement="top" title="'+ res.mydata[i].inspection_title +'">'+ truncateString(res.mydata[i].inspection_title, 100) +'</a></td>'
               
               content +='<td>'+hq+'</td>'
               content +='<td>'+div+'</td>'
             

              content += `<td>
                              <a type="button" class="btn btn-primary btn-sm" href="/inspectionReportHtml/${res.mydata[i].inspection_no}" target="_blank">View</a>
                              <a type="button" class="btn btn-success btn-sm" href="/approve_deletion/${res.mydata[i].inspection_no}" target="_blank">Approve</a>
                              <a type="button" class="btn btn-danger btn-sm" href="/reject_deletion/${res.mydata[i].inspection_no}" target="_blank">Reject</a>
                          </td>`


               content += '</tr>'
             }
             
             $('#instituteTable tbody').append(content)
             table = $('#instituteTable').DataTable({
                           "language": {
                 "search": "Keyword search:"
               },
               "aaSorting": [[ 1, "desc" ]] ,
               "aoColumns": [
                 null,
                 null,
                 { "sType": "date-uk" },
                 null,
                 null,
                 null,
                 null,
                 null,

               ],
               "fnRowCallback" : function(nRow, aData, iDisplayIndex){
                 $("td:first", nRow).html(iDisplayIndex +1);
                return nRow;
               }
             });
             $('.js-btn-tooltip').tooltip();
           }
       });
 }
 


function formatDate(date) {
    var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();

    if (month.length < 2) 
        month = '0' + month;
    if (day.length < 2) 
        day = '0' + day;
    let newyear = String(year).slice(2, 5)
    return [day,month,newyear].join('-');
}

//for tooltip
$(document).ready(function(){
  
  $('.js-btn-tooltip').tooltip();
 
  
  
});

function truncateString(str, num) {
  if (str.length > num) {
    return str.slice(0, num) + "...";
  } else {
    return str;
  }
}

</script>

<script>
  jQuery.extend( jQuery.fn.dataTableExt.oSort, {
    "date-uk-pre": function ( a ) {
        var ukDatea = a.split('/');
        return (ukDatea[2] + ukDatea[1] + ukDatea[0]) * 1;
    },

    "date-uk-asc": function ( a, b ) {
        return ((a < b) ? -1 : ((a > b) ? 1 : 0));
    },

    "date-uk-desc": function ( a, b ) {
        return ((a < b) ? 1 : ((a > b) ? -1 : 0));
    }
    } );
    function pdfDet(id) {
    window.open("{% url 'pdfDetails' %}" + "?id=" + id);
  }
</script>
  
<script>

function confirmApproval(insp_id,insp_note) {
    if (confirm("Do you want to delete Inspection ID " + insp_note + "?")) {
        $.ajax({
            url: "/approve_deletion/" + insp_id + "/",
            type: "GET",
            success: function () {
                $.ajax({
                    url: "/insert_deleted_data/" + insp_id + "/",
                    type: "POST",
                    data: {
                        insp_id: insp_id,
                        csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
                    },
                    success: function (response) {

                    console.log(response);  // Helps you debug

                        if (response.status === "success") {
                            alert("Inspection successfully approved and deleted!");
                            location.reload(); // refresh to update table
                        } else {
                            alert("Error: " + response.message);
                        }
                    },
                    error: function () {
                        alert("Something went wrong while inserting data.");
                    }
                });
            },
            error: function () {
                alert("Something went wrong during approval.");
            }
        });
    }
}

function rejectDeletion(insp_id,insp_note) {
    if (confirm("Do you want to reject deletion of Inspection ID " + insp_note + "?")) {
        $.ajax({
            url: "/reject_deletion/" + insp_id + "/",
            type: "GET",
            success: function () {
                alert("Deletion request rejected.");
                location.reload();
            },
            error: function () {
                alert("Something went wrong while rejecting.");
            }
        });
    }
}

  </script>

  {% endblock %}  