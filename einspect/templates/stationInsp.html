{% extends 'base.html' %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous"> -->
    <script src="{% static '/js/jquery-3.4.1.min.js' %}"></script>
    <script src="{% static '/js/popper.min.js' %}"></script>
    <script src="{% static '/js/Chart.min.js' %}"></script>
    <script src="{% static '/js/jquery-3.3.1.slim.min.js' %}"></script>
    <script src="{% static '/js/bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="{% static '/js/jquery-ui.js' %}"></script>
    <script src="{% static '/js/jquery-1.12.4.js' %}"></script>
    <script src="{% static '/js/select2.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static '/css/select2.min.css' %}" />
    <script src="{% static '/js/moment.min.js' %}"></script>

    <script src="{% static '/js/jquery-3.3.1.js' %}"></script>
    <script src="{% static '/js/sweetalert.min.js' %}"></script>
    <script src="{% static '/js/jquery.min.js' %}"></script>
    <script src="{% static '/js/bootstrap.min1.js' %}"></script>
    <script src="{% static '/js/jquery.min1.js' %}"></script>
    <script src="{% static '/js/jquery-ui.min.js' %}"></script>
    <script src="{% static '/js/jspdf.min.js' %}"></script>

    <script src="{% static '/DataTables/datatables.min.js' %}"></script>
    <!-- <script src="{% static '/js/dataTables.bootstrap4.min.js' %}"></script> -->
    <link rel="stylesheet" type="text/css" href="{% static '/DataTables/datatables.min.css' %}" />


    <link rel="stylesheet" type="text/css" href="{% static '/css/bootstrap.min.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static '/css/jquery-ui.css' %}" />

    <script src="{% static '/js/jquery.timepicker.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static '/css/jquery.timepicker.min.css' %}" />

    <!-- swasti link -->

    <script type="text/javascript" src="{% static '/daterangepicker-master/moment.min.js'%}"></script>
    <script type="text/javascript" src="{% static '/datepicker-master/moment.min.js'%}"></script>
    <script type="text/javascript" src="{% static '/daterangepicker-master/daterangepicker.js'%}"></script>

    <link rel="stylesheet" type="text/css" href="{%static '/daterangepicker-master/daterangepicker.css'%}" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>

    <!-- (Optional) Latest compiled and minified JavaScript translation files -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/i18n/defaults-*.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
  <script rel="stylesheet" href="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" type="text/css" href="{% static '/css/forms_common.css' %}" />

  <link rel="stylesheet" type="text/css" href="{% static '/css/forms_common.css' %}" />

    <title>Station Report</title>
</head>

<body>
    <div>
        <h3 id="h6" class="report_heading">{{div}} Station Inspection Review</h3>
    </div>

    <div class="container">
                
        <div class="row inpt-container mt-5" id="filterForm">

            <div class="col-lg-2" >
                <div class="form-group">
                    <label class="lbl-caption">Station Category</label>
                    <select class="form-control select2" multiple id="stncat">
                        <option disabled>---Select---</option>
                        {% for i in stncats %}
                        <option value="{{i.station_cat}}">{{i.station_cat}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-lg-2">
                <div class="form-group">
                    <label class="lbl-caption">From Date</label>
                    <br>
                    <input readonly type="text" autocomplete="off" placeholder="dd/mm/yy"
                        class="form-control fromdate" name="fromdate" id="fromdate">
                </div>
            </div>
            <div class="col-lg-2">
                <div class="form-group">
                    <label class="lbl-caption">To Date</label>
                    <br>
                    <input readonly type="text" autocomplete="off" placeholder="dd/mm/yy"
                        class="form-control todate" name="todate" id="todate">
                </div>
            </div>

            <div class="col-lg-6 col-md-12 col-sm-12 ">
                <div class="container form-group " >
                    <div class="row float-right" >
                      <div class="btn-toolbar mx-1" role="toolbar">
                          <div class="btn-group" role="group" >
                            <button type="button" class="btn btn-warning btn-sm" type="button" id="search"  style="margin-top:30px ;white-space: normal; word-wrap: break-word;" value="" onclick="searchDet()">Continue</button>
                            <button type="button" class="btn btn-secondary btn-sm" type="button" id="btnReset"  style="margin-top:30px ;white-space: normal; word-wrap: break-word;" value="reset">Reset</button>                          
                          </div>
                      </div>
      
                      <div class="btn-toolbar mx-1 " role="toolbar" >
                          <div class="btn-group" role="group" >
                            <button type="button" name="submitpdf" id="submitpdf"  style="margin-top:30px ;white-space: normal; word-wrap: break-word;" class="btn btn-danger btn-sm" value="PDF"  onclick="pdfShow()" >PDF <i class="fa fa-file-pdf"></i></button> 
                            <button type="button" name="submitexcel" style="margin-top:30px ;white-space: normal; word-wrap: break-word;" id="submitexcel" class="btn btn-success btn-sm" value="excel"  onclick="excelShow()" >Excel <i class="fa fa-file-excel"></i></button> 
                            <button type="button" name="showdata" id="showdata" class="btn btn-primary submitpdf" style="margin-top:30px ;white-space: normal; word-wrap: break-word;"  onclick="showdata()" data-toggle="modal" data-target="#Modal">Pie Chart <i
                            class="fa fa-file-pdf"></i></button>
                          </div>
                      </div>
                    </div>
                </div>
              </div>

        </div>
            
        <div class="modal fade" id="Modal" role="dialog" aria-labelledby="userModal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            <class class="modal-header">
                    <h3 class="modal-title text-center" id="userModal">Show Data</h3>
                    <button class="close" type="button" data-dismiss="modal" aria-label="close" style="color:black;"><span
                    class="glyphicon glyphicon-remove">&times;</span></button>
                </class>
                <br>
                
                <div class="chart2" id="zone">
                <div class="card shadow ">
                    <div class="card-header" style="height:4rem">
                        <h6 class="font-weight-bold text-primary text-center">
                            Inspection Data(Inspection completed/Total Scheduled)
                        </h6>
                    </div>

                    <div class="card-body d-flex flex-column " style="padding: 0.25rem; height: 100%;">

                        <div class="tab-pane fade show active1" role="tabpanel"
                            aria-labelledby="flamingo-tab">
                            
                            <canvas id="myChart" width="400" height="400"></canvas>

                        </div>

                    </div>
                </div>
            </div> 
                
            <!-- <div class="modal-body">
                <img id="showimage" width="470" height="300">
            </div> -->
            <div>

            </div>
            </div>
        </div>
        </div>

        <!-- <div class="row"
            style="background-color:#426fcf;  color: white ;font-weight: bold; vertical-align: middle; padding-top: 5px;  padding-bottom: 5px; height: 40px; margin-left: 1.3%; margin-right: 1.1%; margin-bottom: 3px;">
            <i class="fa-solid fa-thumbtack" style="margin-top:5px; margin-left:10px ;"></i>&nbsp;
            Show Entries &nbsp;

            <div class="">
                <select name="category" id="selectedCategory" style="height:25px; border-radius:3% ;">
                    <option value="" selected="selected" disabled>Select</option>
                    <option>{{details|length}}</option>


                </select>
            </div>&nbsp;(No. of records:&nbsp;<spa

            <button type="button"
                style="font-size: medium; border-radius: 4px; border: 2px solid #e7e7e7;background-color: white; margin-left: 2vw;"
                value="filter" onclick="show_filters(this.val)"><i class="fa fa-filter"></i>Filter</button>

           </h4> 


            <i class="fa-solid fa-magnifying-glass" style="margin-left:26% ;margin-top:0.5%"></i>
            <input id="myInput" type="text" placeholder="Search Text..."
                style="margin-left: 70%; margin-top: -1.8em; border-radius: 5px; height: 25px;">
            <i class="fa-solid fa-print" style="margin-top:-2%; cursor: pointer; margin-left: 4vw; "
                onclick="window.print();"></i>


        </div> -->

        <div class="container mt-5">
            <div class="row" style="background-image: radial-gradient(circle farthest-side, #fceabb, #f8b500);  color: black ;font-weight: bold;height: 40px; vertical-align: middle;">
              <div class="col-lg-6 my-1">
                <div class="row ml-1">
                  Show      
                  <div class="col-lg-5">
                    <select name="category" class="form-control-sm" id="selectedCategory" style="width:100%;">
                      <option value="" selected="selected" disabled>Select</option>
                      <option>10</option>
                      <option>50</option>
                    </select>
                  </div>
                  Entries
                </div>
              </div>       
          
              <div class="col-lg-6 my-1">
                <div class="row float-right mr-2">
                    <button class="btn btn-sm bg-white mr-2" style="height:30px; margin-top: 2px;" type="button" id="filterButton" value="filter" onclick="show_filters(this.val)" >
                      <i class="fa fa-filter fa-sm"></i>
                      Toggle Filter
                    </button>
                            
                    <div class="form-inline float-right">         
                      <div>
                        <input type="text" class="form-control form-control-sm" id="myInput" placeholder="Search Text..." >
                      </div>
                      <div>
                        <i class="fa-solid fa-print my-2 mx-2" onclick="window.print();"></i>
                      </div>          
                    </div>
                  </div>
                </div>
              </div> 
          </div> 

        <table class="table table-sm table-data table-striped table-lg table-bordered table-hover "
            id="show_details">
            <thead class="" id="thead_IC" style="background-color:#f7f1e8;">
                <tr>
                    <th scope="col">Station Category</th>
                    <th scope="col">Total Inspections</th>
                    <th scope="col">Max. Inspected</th>
                    <th scope="col">Min. Inspected</th>
                    <th scope="col">Improving</th>
                    <th scope="col">Best Station</th>
                </tr>
            </thead>
            <tbody id="details121"></tbody>
        </table>

    </div>



</body>
<script>
//   function showdata(){
//     $('zone').show();
//   }
// $(document).ready(function(){
//     $('#zone').hide();
   

// })

    // Chart.register(ChartDataLabels);
    let myChart = null;
    const ctx = document.getElementById('myChart').getContext('2d');
    // ctx.destroy();
    let inspcompleted = {{ inspcompleted| safe}}
    let totalscheduled = {{ totalscheduled | safe}}
    let per = {{ per | safe}}
    let stncats3 = {{ stncats3 | safe}}
    console.log('notajax')
    // ['A', 'A1','B', 'D', 'E', 'F']
    myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: stncats3,
            datasets: [
                {
                    label: 'total',
                    data: per,
                    backgroundColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235,1)',
                        'rgba(255, 206, 86,1)',
                        'rgba(75, 192, 192,1)',
                        'rgba(153, 102, 255,1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }

            ]
        },
        options: {
            plugins: {
                datalabels: {
                    anchor: 'center',
                    align: 'center',
                    formatter: Math.round,
                    font: {
                        weight: 'bold',
                        size: 16
                    }
                }
            }
        }
    });
    // myChart.destroy();
    $('#filterForm').show();
    $(document).ready(function () {
        var currentdate = new Date();
        var startdate = moment().subtract(7, 'days')
        var enddate = moment()
        $("#fromdate").val(startdate.format('DD-MM-YYYY'))
        $("#todate").val(enddate.format('DD-MM-YYYY'))
        $("#fromdate").datepicker({
            maxDate: currentdate,
            autoclose: true,
            dateFormat: "dd-mm-yy",
            endDate: "currentdate",
            changeMonth: true,
            changeYear: true,
            todayHighlight: true,
            clearBtn: true
        });
        $('#fromdate').change(function () {
            var fromdate = $("#fromdate").val()
            console.log("Heyy", fromdate)
            var currentdate = new Date();
            $("#todate").val(currentdate.getDate() + "-" + parseInt(currentdate.getMonth() + 1) + "-" + currentdate.getFullYear())
            $("#todate").datepicker({
                maxDate: currentdate,
                minDate: fromdate,
                autoclose: true,
                dateFormat: "dd-mm-yy",
                changeMonth: true,
                changeYear: true,
                todayHighlight: true,
                clearBtn: true
            });
        })
        var table = $('#show_details').DataTable({
                                            // scrollX: true,
                                            // scrollY:true,
                                            // scrollCollapse: true,
                                            // paging: true,
                                            serverSide: false,
                                            pageLength : 10,
                                            retrieve: true,
                                            "lengthChange": false,
                                            searching: false, 
                                            pagingType: "simple",
                                            "language": {
                                            "info": "Page _PAGE_ of _PAGES_",
                                            }
                                          });
        searchDet()

    });

    function pdfShow() {
        var fromdate = $('#fromdate').val();
        var todate = $('#todate').val();
        stncat1 = $('#stncat').val();
        submitbtn = $('#submitpdf').val();
        // alert(submitbtn)
        // alert(stncat1)
        window.open("{% url 'stationReviewpdf' %}" + "?fromdate=" + fromdate + "&todate=" + todate + '&stncat1=' + stncat1 + '&submitbtn=' + submitbtn + '&_blank');
    }

    function excelShow() {
        var fromdate = $('#fromdate').val();
        var todate = $('#todate').val();
        stncat1 = $('#stncat').val();
        submitbtn = $('#submitexcel').val();
        // alert(submitbtn)
        window.location.href = "{% url 'stationReviewpdf' %}" + "?fromdate=" + fromdate + "&todate=" + todate + '&stncat1=' + stncat1 + '&submitbtn=' + submitbtn;
    }

    //  ctx.destroy();
    function searchDet() {
        var fromdate = $('#fromdate').val();
        var todate = $('#todate').val();
        stncat1 = $('#stncat').val();
        console.log(stncat1)
        data = { 'fromdate': fromdate, 'todate': todate, 'stncat1': stncat1 }
        $("#details121").empty();
        $.ajax({
            url: '{% url "searchDet" %}',
            type: 'GET',
            data: data,
            success: function (response) {
                //    console.log(response.details['A']['inspcomp'])
                console.log(response.details)
                $('#show_details tbody').empty();
                var s = 0;
                for (i in response.details) {
                    $('#show_details tbody').append
                        (
                            `<tr>
                       <td>${i} (${response.details[i]['cnt']})</td>
                       <td>${response.details[i]['tot']}</td>
                       <td>${response.details[i]['mxins']} ${response.details[i]['mx']}</td>
                       <td>${response.details[i]['mnins']} ${response.details[i]['mn']}</td>
                       <td>${response.details[i]['improving']}</td>
                       <td>${response.details[i]['best']}</td>
                       </tr>`
                        )
                }
                // document.getElementById("num").innerHTML = response.length;
                myChart.destroy();
                console.log('ajax2')
                const ctx = document.getElementById('myChart').getContext('2d');
                console.log('ajax3')
                let inspcompleted
                let totalscheduled
                let stncats2
                for (i in response.details) {
                    inspcompleted = response.details[i]['inspcomp']
                    totalscheduled = response.details[i]['totsch']
                    stncats2 = response.details[i]['l1']
                }
                console.log("inspcompleted", inspcompleted)
                console.log("totalscheduled", totalscheduled)
                console.log("stncats2", stncats2)
                per = []
                for (i = 0; i < totalscheduled.length; i++) {
                    if (totalscheduled[i] || inspcompleted[i] != 0)
                        per[i] = inspcompleted[i] / totalscheduled[i]
                    else
                        per[i] = 0
                }
                var table = $('#show_details').DataTable({
                                            // scrollX: true,
                                            // scrollY:true,
                                            // scrollCollapse: true,
                                            // paging: true,
                                            serverSide: false,
                                            pageLength : 10,
                                            retrieve: true,
                                            "lengthChange": false,
                                            searching: false, 
                                            pagingType: "simple",
                                            "language": {
                                            "info": "Page _PAGE_ of _PAGES_",
                                            }
                                          }); 
                console.log("%%%%%%%%%", per)
                // ['A', 'A1','B', 'D', 'E', 'F']
                myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: stncats2,
                        datasets: [
                            {
                                label: 'total',
                                data: per,
                                backgroundColor: [
                                    'rgba(255, 99, 132, 1)',
                                    'rgba(54, 162, 235,1)',
                                    'rgba(255, 206, 86,1)',
                                    'rgba(75, 192, 192,1)',
                                    'rgba(153, 102, 255,1)',
                                    'rgba(255, 159, 64, 1)'
                                ],
                                borderColor: [
                                    'rgba(255, 99, 132, 1)',
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(255, 206, 86, 1)',
                                    'rgba(75, 192, 192, 1)',
                                    'rgba(153, 102, 255, 1)',
                                    'rgba(255, 159, 64, 1)'
                                ],
                                borderWidth: 1
                            }

                        ]
                    },
                    options: {
                        plugins: {
                            datalabels: {
                                anchor: 'center',
                                align: 'center',
                                formatter: Math.round,
                                font: {
                                    weight: 'bold',
                                    size: 16
                                }
                            }
                        }
                    }
                });




            }






        })

        // const ctx = document.getElementById('myChart').getContext('2d');
        // let inspcompleted={{inspcompleted2| safe}}
        // let totalscheduled={{totalscheduled2 | safe}}
        // let per={{per2 | safe}}
        // let stncats2={{stncats22 | safe}}
        // // ['A', 'A1','B', 'D', 'E', 'F']
        // const myChart = new Chart(ctx, {
        //     type: 'doughnut',
        //     data: {
        //         labels:  stncats2,
        //         datasets: [
        //             {
        //             label: 'total',
        //             data: per,
        //             backgroundColor: [
        //                 'rgba(255, 99, 132, 1)',
        //                 'rgba(54, 162, 235,1)',
        //                 'rgba(255, 206, 86,1)',
        //                 'rgba(75, 192, 192,1)',
        //                 'rgba(153, 102, 255,1)',
        //                 'rgba(255, 159, 64, 1)'
        //             ],
        //             borderColor: [
        //                 'rgba(255, 99, 132, 1)',
        //                 'rgba(54, 162, 235, 1)',
        //                 'rgba(255, 206, 86, 1)',
        //                 'rgba(75, 192, 192, 1)',
        //                 'rgba(153, 102, 255, 1)',
        //                 'rgba(255, 159, 64, 1)'
        //             ],
        //             borderWidth: 1
        //         }

        //     ]
        //     },
        //     // options: {
        //     //     scales: {
        //     //         y: {
        //     //             stacked:true,
        //     //             beginAtZero: true
        //     //         }
        //     //     }
        //     // }
        // });
    }
    $(document).ready(function () {
        $("#details121").empty();
        $("#myInput").on("keyup", function () {
      var value = $(this).val().toLowerCase();
      $("#show_details tr").filter(function () {
        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)

      });

    });
    // $("#tbody_IC").empty()
    // $('#show_details tbody').empty();
        $.ajax
            ({
                url: '{% url "showDet" %}',
                dataType: 'json',
                type: 'GET',
                success: function (response) {

                    // table.destroy();

                    //    console.log(response.details)
                    for (i in response.details) {
                        $('#show_details tbody').append
                            (
                                `<tr>
                       <td>${i} (${response.details[i]['cnt']})</td>
                       <td>${response.details[i]['tot']}</td>
                       <td>${response.details[i]['mxins']} ${response.details[i]['mx']}</td>
                       <td>${response.details[i]['mnins']} ${response.details[i]['mn']}</td>
                       <td>${response.details[i]['improving']}</td>
                       <td>${response.details[i]['best']}</td>
                       </tr>`
                            )
                    }
                    // document.getElementById("num").innerHTML = response.length;

                    var table = $('#show_details').DataTable({
                                            // scrollX: true,
                                            // scrollY:true,
                                            // scrollCollapse: true,
                                            // paging: true,
                                            serverSide: false,
                                            pageLength : 10,
                                            retrieve: true,
                                            "lengthChange": false,
                                            searching: false, 
                                            pagingType: "simple",
                                            "language": {
                                            "info": "Page _PAGE_ of _PAGES_",
                                            }
                                          }); 
                }
                
            })


    });

    $('#btnReset').click(function () {

        var currentdate = new Date();
        var startdate = moment().subtract(7, 'days')
        var enddate = moment()
        $("#fromdate").val(startdate.format('DD-MM-YYYY'))
        $("#todate").val(enddate.format('DD-MM-YYYY'))
        var stncat1 = $('#stncat').val('');
        $("#details121").empty();
        $.ajax
            ({
                url: '{% url "showDet" %}',
                dataType: 'json',
                type: 'GET',
                success: function (response) {

                    // table.destroy();

                    //    console.log(response.details)
                    for (i in response.details) {
                        $('#show_details tbody').append
                            (
                                `<tr>
                       <td>${i} (${response.details[i]['cnt']})</td>
                       <td>${response.details[i]['tot']}</td>
                       <td>${response.details[i]['mxins']} ${response.details[i]['mx']}</td>
                       <td>${response.details[i]['mnins']} ${response.details[i]['mn']}</td>
                       <td>${response.details[i]['improving']}</td>
                       <td>${response.details[i]['best']}</td>
                       </tr>`
                            )
                    }
                    document.getElementById("num").innerHTML = response.length;
                    var table = $('#show_details').DataTable({
                                            // scrollX: true,
                                            // scrollY:true,
                                            // scrollCollapse: true,
                                            // paging: true,
                                            serverSide: false,
                                            pageLength : 10,
                                            retrieve: true,
                                            "lengthChange": false,
                                            searching: false, 
                                            pagingType: "simple",
                                            "language": {
                                            "info": "Page _PAGE_ of _PAGES_",
                                            }
                                          }); 
                    
                }
            })


    });

    function show_filters(val) {

        $('#filterForm').toggle();
    }
</script>
<script>
    $('.select2').select2();
</script>

</html>
{% endblock content %}