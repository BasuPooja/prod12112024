{% extends 'base.html' %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Report</title>

    <script src="{% static '/js/jquery-3.4.1.min.js' %}"></script>
    <script src="{% static '/js/popper.min.js' %}"></script>
    <script src="{% static '/js/Chart.min.js' %}"></script>
    <script src="{% static '/js/jquery-3.3.1.slim.min.js' %}"></script>
    <script src="{% static '/js/bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="{% static '/js/jquery-ui.js' %}"></script>
    <script src="{% static '/js/jquery-1.12.4.js' %}"></script>
    <script src="{% static '/js/select2.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static '/css/select2.min.css' %}" />
    <script src="{% static '/js/moment.min.js' %}"></script>

    <script src="{% static '/js/jquery-3.3.1.js' %}"></script>
    <script src="{% static '/js/sweetalert.min.js' %}"></script>
    <script src="{% static '/js/jquery.min.js' %}"></script>
    <script src="{% static '/js/bootstrap.min1.js' %}"></script>
    <script src="{% static '/js/jquery.min1.js' %}"></script>
    <script src="{% static '/js/jquery-ui.min.js' %}"></script>
    <script src="{% static '/js/jspdf.min.js' %}"></script>

    <script src="{% static '/DataTables/datatables.min.js' %}"></script>
    <!-- <script src="{% static '/js/dataTables.bootstrap4.min.js' %}"></script> -->
    <link rel="stylesheet" type="text/css" href="{% static '/DataTables/datatables.min.css' %}" />

    <link rel="stylesheet" type="text/css" href="{% static '/css/bootstrap.min.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static '/css/jquery-ui.css' %}" />

    <script src="{% static '/js/jquery.timepicker.min.js' %}"></script>


    <!-- swasti link -->

    <script type="text/javascript" src="{% static '/daterangepicker-master/moment.min.js'%}"></script>
    <script type="text/javascript" src="{% static '/daterangepicker-master/daterangepicker.js'%}"></script>
    <link rel="stylesheet" type="  text/css" href="{%static '/daterangepicker-master/daterangepicker.css'%}" />

    <script type="text/javascript" src="{% static '/js/dataTables.fixedColumns.min.js' %}"></script>
    <link rel="stylesheet" type="  text/css" href="{% static '/css/dataTables.fixedColumns.min.css' %}" />
    
    <link rel="stylesheet" type="text/css" href="{% static '/css/forms_common.css' %}" />

</head>
<style>
    input {
        border: 1px solid transparent;
        background-color: #f1f1f1;
        padding: 10px;
        font-size: 16px;
    }

    input[type=text] {
        background-color: #f1f1f1;
        width: 100%;
    }


    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        /*position the autocomplete items to be the same width as the container:*/
        top: 100%;
        left: 0;
        right: 0;
    }

    .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        background-color: #fff;
        border-bottom: 1px solid #d4d4d4;
    }

    /*when hovering an item:*/
    .autocomplete-items div:hover {
        background-color: #e9e9e9;
    }

    /*when navigating through the items using the arrow keys:*/
    .autocomplete-active {
        background-color: DodgerBlue !important;
        color: #ffffff;
    }
</style>

<body>
    
    <div>
        <h3 id="h6" class="report_heading">Analysis Report</h3>
    </div>

    <div class="container">
        <div class="container inpt-container mt-5" id="filterForm">
            <div class="row">
                <div class="col-lg-2">
                    <div class="form-group">
                        <label class="lbl-caption">From Date</label>
                        <input type="text" autocomplete="off" placeholder="dd/mm/yy" class="form-control fromdate"
                            name="fromdate" id="fromdate">
                    </div>
                </div>
                <div class="col-lg-2">
                    <div class="form-group">
                        <label class="lbl-caption">To Date</label>
                        <input type="text" autocomplete="off" placeholder="dd/mm/yy" class="form-control todate"
                            name="todate" id="todate">
                    </div>
                </div>
                <div class="col-lg-2">
                    <div class="form-group">
                        <label class="lbl-caption">Inspection-Type</label>
                        <select class="form-control select2" id="insp" data-live-search="true" data-actions-box="true">
                            <option selected>Select</option>
                            {% for i in insp_type %}
                            <option value="{{i.shortcode}}">{{i.shortcode}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-lg-2">
                    <div class="form-group">
                        <label class="lbl-caption">Priority</label>
                        <select class="form-control select2" id="priority" data-live-search="true" data-actions-box="true">
                            <option selected>Select</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                </div>
                <div class="col-lg-2">
                    <div class="form-group">
                        <label class="lbl-caption">Report Type</label>
                        <select class="form-control select2" id="report_type" data-live-search="true"
                            data-actions-box="true">
                            <option selected>Select</option>
                            <option value="Maintainance">Maintainance</option>
                            <option value="Safety">Safety</option>
                            <option value="Passenger Amenities">Passenger Amenities</option>
                            <option value="Workplace">Workplace</option>
                            <option value="Operations">Operations</option>
                            <option value="Trespassing">Trespassing</option>
                            <option value="Innovation">Innovation</option>
                            <option value="Encroachment">Encroachment</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                </div>
                <div class="col-lg-2 col-md-12 col-sm-12 ">
                    <div class="row text-center" >
                      <div class="form-group mx-auto" >
                          <div class="btn-toolbar mx-1" role="toolbar">
                              <div class="btn-group" role="group" >
                                <!-- <button type="button" class="btn btn-warning btn-sm" type="reset" id="btnReset"  style="margin-top:15px ;white-space: normal; word-wrap: break-word;" value="submit" onclick="searchCompliance()">Search</button>
                                <button type="button" class="btn btn-secondary btn-sm" type="reset" id="btnReset"  style="margin-top:15px ;white-space: normal; word-wrap: break-word;" value="submit" onclick="myFunction()">Reset</button>                           -->
                                <button type="button" class="btn btn-warning btn-sm" type="reset"  style="margin-top:15px ;white-space: normal; word-wrap: break-word;"  onclick="searchDetails()">Search</button>
                                <button type="button" class="btn btn-secondary btn-sm" type="reset"  style="margin-top:15px ;white-space: normal; word-wrap: break-word;"  id="btnReset" value="Reset" onclick="resetEntries()">Reset</button>
                            </div>
                          </div>
          
                          <div class="btn-toolbar mx-1 " role="toolbar" >
                              <div class="btn-group" role="group" >
                                <!-- <button type="button" name="submitpdf" id="submitpdf"  style="margin-top:15px ;white-space: normal; word-wrap: break-word;" class="btn btn-danger btn-sm" value="PDF"  onclick="pdfShow()" >PDF <i class="fa fa-file-pdf"></i></button> 
                                <button type="button" name="submitexcel" style="margin-top:15px ;white-space: normal; word-wrap: break-word;" id="submitexcel" class="btn btn-success btn-sm" value="excel"  onclick="excelShow()" >Excel <i class="fa fa-file-excel"></i></button>  -->
                                <button type="button" name="submitpdf" id="submitpdf" class="btn btn-danger btn-sm" value="PDF"  style="margin-top:15px ;white-space: normal; word-wrap: break-word;" onclick="pdfShow()">PDF <i class="fa fa-file-pdf"></i></button>
                                <button type="button" name="submitpdf" id="submitexcel" class="btn btn-success btn-sm" value="excel"  style="margin-top:15px ;white-space: normal; word-wrap: break-word;" onclick="excelShow()">Excel <i class="fa fa-file-excel"></i></button>
                              </div>
                          </div>
                        </div>
                    </div>
                  </div>
                <!-- <div class="col-lg-2">
                    <div class="form-group">
                        <br>
                        <form>
                            <button type="button" class="btn btn-primary mb-2" onclick="searchDetails()">Search</button>
                            <button class="btn btn-primary mb-2" type="button" id="btnReset" value="Reset" onclick="resetEntries()">Reset</button>
                        </form>
                    </div>
                </div>
                <button type="button" name="submitpdf" id="submitpdf" class="btn btn-danger submitpdf" value="PDF"  style="margin-top:15px ;white-space: normal; word-wrap: break-word;" onclick="pdfShow()">PDF <i class="fa fa-file-pdf"></i></button>
                <button type="button" name="submitpdf" id="submitexcel" class="btn btn-success submitpdf" value="excel"  style="margin-top:15px ;white-space: normal; word-wrap: break-word;"onclick="excelShow()">Excel <i class="fa fa-file-excel"></i></button> -->
            </div>
        </div>

        <div class="container mt-5">
            <div class="row" style="background-image: radial-gradient(circle farthest-side, #fceabb, #f8b500);  color: black ;font-weight: bold;height: 40px; vertical-align: middle;">
              <div class="col-lg-6 my-1">
                <div class="row ml-1">
                  Show      
                  <div class="col-lg-5">
                    <select name="category" class="form-control-sm" id="selectedCategory" style="width:100%;">
                      <option value="" selected="selected" disabled>Select</option>
                      <option>10</option>
                      <option>50</option>
                    </select>
                  </div>
                  Entries
                </div>
              </div>       
          
              <div class="col-lg-6 my-1">
                <div class="row float-right mr-2">
                    <button class="btn btn-sm bg-white mr-2" style="height:30px; margin-top: 2px;" type="button" id="filterButton" value="filter" onclick="show_filters(this.val)" >
                      <i class="fa fa-filter fa-sm"></i>
                      Toggle Filter
                    </button>
                            
                    <div class="form-inline float-right">         
                      <div>
                        <input type="text" class="form-control form-control-sm" id="myInput" placeholder="Search Text..." >
                      </div>
                      <div>
                        <i class="fa-solid fa-print my-2 mx-2" onclick="window.print();"></i>
                      </div>          
                    </div>
                  </div>
                </div>
              </div> 
          </div>  
    
        <table class="table table-sm table-bordered table-data table-sm" id="show_details">
            <thead id="thead_report">
                <tr>
            
                </tr>
            </thead>
            <tbody id="tbody_report"></tbody>
        </table>

    </div>

</body>
<script>

    

    $(document).ready(function () {

        $("#myInput").on("keyup", function(){
        var value = $(this).val().toLowerCase();
        $("#tbody_report tr").filter(function() {
        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)

    });

    });
        $('#filterForm').show();
        var currentdate = new Date();
        var startdate = moment().subtract(7, 'days')
        var enddate = moment()
        $(".fromdate").val(startdate.format('DD/MM/YYYY'))
        $(".todate").val(enddate.format('DD/MM/YYYY'))
        $(".fromdate").datepicker({
            maxDate: currentdate,
            autoclose: true,
            dateFormat: "dd/mm/yy",
            endDate: "currentdate",
            changeMonth: true,
            changeYear: true,
            todayHighlight: true,
            clearBtn: true
        });
        $('#fromdate').change(function () {
            var fromdate = $("#fromdate").val()
            console.log("Heyy", fromdate)
            var currentdate = new Date();
            $(".todate").val(currentdate.getDate() + "/" + parseInt(currentdate.getMonth() + 1) + "/" + currentdate.getFullYear())
            $(".todate").datepicker({
                maxDate: currentdate,
                minDate: fromdate,
                autoclose: true,
                dateFormat: "dd/mm/yy",
                changeMonth: true,
                changeYear: true,
                todayHighlight: true,
                clearBtn: true
            });
        })
        
        searchDetails();
    });

    
    var table;
    function searchDetails() {
        if(table instanceof $.fn.DataTable.Api)
        {
            table.destroy();
        }
        $('#show_details thead').empty();
        $('#show_details tbody').empty();

        var fromdate = $('#fromdate').val();
        var todate = $('#todate').val();
        var insp = $('#insp').val();
        var priority = $('#priority').val();
        var report_type = $('#report_type').val();
        data = {
            'fromdate': fromdate,
            'todate': todate,
            'insp': insp,
            'priority': priority,
            'report_type': report_type,
        }
       
       
        $.ajax
            ({
                url: '{% url "searchEInspectDetails" %}',
                dataType: 'json',
                type: 'GET',
                data: data,
                success: function (response) {
                    var ro = '';
                    var row = '';
                    console.log(response)
                    let header = response.ans;
                    console.log(header)
                  

                    var ro = '';
                    var row = '';

                    ro += '<tr>';
                    ro += `
                        <th scope="col">SNo.</th>;
                        <th scope="col">Deficiency</th>;
                    `
                    for (const [key, value] of Object.entries(header)) {
                        for (const [key1, value1] of Object.entries(value))
                            ro += `<th scope="col">${key1}</th>`;
                        break
                    }
                    ro += '</tr>';


                    let ctr = 0;


                    for (const [key, value] of Object.entries(header)) {
                        ctr++;

                        row += '<tr>';
                        row += `<td scope="col">${ctr}</td>`;
                        row += `<td scope="col">${key}</td>`;
                        console.log(key)
                        for (const [key1, value1] of Object.entries(value)) {
                            row += `<td scope="col">${value1}</td>`;
                        }
                        row += '</tr>';
                    }

                    // table123.destroy();
                    $('#show_details thead').append(ro);
                    $('#show_details tbody').append(row);
                    
                    table = $('#show_details'). DataTable({
                                            // scrollX: true,
                                            // scrollY:true,
                                            // scrollCollapse: true,
                                            // paging: true,
                                            serverSide: false,
                                            pageLength : 10,
                                            retrieve: true,
                                            "lengthChange": false,
                                            searching: false, 
                                            pagingType: "simple",
                                            "language": {
                                            "info": "Page _PAGE_ of _PAGES_",
                                            }
                                          }); 
                }
            })

    }

    function pdfShow()
    {
        var fromdate = $('#fromdate').val();
        var todate = $('#todate').val();
        var insp = $('#insp').val();
        var priority = $('#priority').val();
        var report_type = $('#report_type').val();
        submitbtn=$('#submitpdf').val();
        window.open("{% url 'AnalysisReportpdf' %}"+"?fromdate="+fromdate+"&todate="+todate+'&insp='+insp+'&priority='+priority+'&report_type='+report_type+'&submitbtn='+submitbtn+'&_blank');
    }

    function excelShow()
    {
        var fromdate = $('#fromdate').val();
        var todate = $('#todate').val();
        var insp = $('#insp').val();
        var priority = $('#priority').val();
        var report_type = $('#report_type').val();
        submitbtn=$('#submitexcel').val();
        window.location.href="{% url 'AnalysisReportpdf' %}"+"?fromdate="+fromdate+"&todate="+todate+'&insp='+insp+'&priority='+priority+'&report_type='+report_type+'&submitbtn='+submitbtn;
    }

    function resetEntries(){
        var currentdate = new Date();
        var startdate = moment().subtract(7, 'days')
        var enddate = moment()
        $("#fromdate").val(startdate.format('DD/MM/YYYY'))
        $("#todate").val(enddate.format('DD/MM/YYYY'))
        $('#insp').val('')
        $('#priority').val('')
        $('#report_type').val('')
        searchDetails();
    }

    function show_filters(val) {
            $('#filterForm').toggle();
        }

</script>

</html>
{% endblock content %}