{% extends 'base.html' %} 
{% block content %}
{% load static %}
<script type="text/javascript">
  $(".sidebar").addClass('close');
</script>


    
<head>
  <link rel="stylesheet" type="text/css" media="screen" href="{% static '/css/forms_common.css' %}">  
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
    
  
<body>
<h3 style="font-family: 'Lato', sans-serif;">
    <center><b>Inspections Received Compliance</b></center>
  </h3>

  <br>
  

  <div class="col-md-12" style="font-family:'Lato', sans-serif">
    
    <!-- <form  method="POST" class="d-inline " >
          
        {% csrf_token %}
    
    
       
      
    
    <div class="row" id="row1" style="font-family: 'Lato', sans-serif;font-size: 1em;">
        <div class="col-2"  >
            <label for="Zone" >Rly./Org.</label>
            <select class="form-control" id="zone" name="zone" class="custom-select"
                multiple ><span style="color:red;font-weight:bold">*</span>
                <option value="" disabled>select</option>
                {% for z in Zone %}
                <option value="{{z}}">{{z}}</option>
                {% endfor %}
    
            </select>
        </div>
    
       
       
    <div class="col-2">
        <label for="division">Div./Unit</label>
        <select class="form-control" id="division" name="division" class="custom-select" style="max-width:100%;"
        multiple><span style="color:red;font-weight:bold">*</span>
    
                <option value="" disabled>select</option>
                {% for d in division %}
                <option value="{{d}}">{{d}}</option>
                {% endfor %}
    
            </select>
        
    </div>
    <div class="col-2">
      <label for="division">Department</label>
      <select class="form-control" id="department" name="department" class="custom-select" style="max-width:100%;" multiple>
    
              <option value="" disabled>select</option>
              {% for d in department %}
              <option value="{{d.department_name}}">{{d.department_name}}</option>
              {% endfor %}
    
          </select>
      
    </div>
    
    <div  class="col-2" >
      <label for="location" >Location</label><br>
      <div>
        <select name="location" id="location" class="form-control"  multiple>
    
        </select>
      </div>
      
    </div>
  
  
    <div  class="col-3" >
      <label for="location">Date Wise(range)</label><br>
      <div id="date_range" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 100%">
        <i class="fa fa-calendar"></i>&nbsp;
        <span></span> <i class="fa fa-caret-down"></i>
    </div>
      
      
    </div>
  
    <div  class="col-1" >
     
      <button  type="button"  name="zone_loc_submit"  style="margin-top:2em; " class="btn btn-success" id="insp_submit" onclick="getSearchValue()">Search</button>
    </div>
     
  
      
    </form> -->

    <form  method="POST" class="d-inline " >
          
      {% csrf_token %}
  
  <div class="row" id="row1" style="font-family: 'Lato', sans-serif;font-size: 1em; margin-left: 4em;">

      <div  class="col-3" >
        <label for="location">Date Wise(range)</label>
        <input id="date_range" class="form-control" name="date_range" autocomplete="off" placeholder="dd/mm/yyyy - dd/mm/yyyy" >
        
       
      </div>

      <div class="col-3"  >
          <label for="Zone" >Rly./Org. Wise </label>
          <select class="form-control" id="zone" data-placeholder="Rly./Org Wise..." name="zone" class="custom-select"
              multiple ><span style="color:red;font-weight:bold">*</span>
              <option value="" disabled>select</option>
              {% for z in Zone %}
              <option value="{{z}}">{{z}}</option>
              {% endfor %}
  
          </select>
      </div>
  
     
     
  <div class="col-3">
      <label for="division">Div./Unit Wise</label>
      <select class="form-control" id="division" data-placeholder="Div./Unit Wise..." name="division" class="custom-select" style="max-width:100%;"
      multiple><span style="color:red;font-weight:bold">*</span>
  
              <option value="" disabled>select</option>
              {% for d in division %}
              <option value="{{d.location_code}}">{{d.location_code}}-{{d.location_type}}</option>
            {% endfor %}
  
          </select>
      
  </div>

  <div class="col-2" hidden>
    <label for="division">Department Wise</label>
    <select class="form-control" id="department"  name="department" class="custom-select" style="max-width:100%;" multiple>
  
            <option value="" disabled>select</option>
            {% for d in department %}
            <option value="{{d.department_name}}">{{d.department_name}}</option>
            {% endfor %}
  
    </select>
    
  </div>
  
  <div  class="col-2" hidden>
    <label for="location" >Location Wise</label><br>
    <div>
      <select name="location" id="location" class="form-control"  multiple>
  
      </select>
    </div>
    
  </div>
  
  <div  class="col-2" >
   
    <button  type="button"  name="zone_loc_submit"  style="margin-top:2em; " class="btn btn-success" id="insp_submit" onclick="getSearchValue()">Search</button>
    <button  type="button"  style="margin-top:2em; " class="btn btn-success" id="insp_clear" onclick="refreshPage()">Clear</button>
  </div>
   

    
    </form>
  </div>
  <br><br>

  <div class="table-responsive co-md-12" style="font-family:'Lato', sans-serif">
    <table id="instituteTable" class="table table-striped table-bordered table-sm;" >
    <thead  style="background-color: #343a40;white-space: nowrap;font-size: 1.1em; color:white;text-align: left;">
        <th>S.No.</th>
        <th >Date of Insp.</th>
        <th >Insp. Note No.</th>
        <th >Insp. Title</th>
        <th >Rly./Org.</th>
        <th >Div./Unit</th>
        <!-- <th >Department</th>
        <th >Location</th>
         -->
         <th >Insp. Note</th>
        <th >Rec'd Reply</th>
            
            
           
            <!-- <th >Status</th> -->
           
        </thead>
        <tbody>

            {% for g in mydata %}
            <tr>
                <td>{{ forloop.counter }}</td>

                {% if g.start_date or g.inspected_on %}
                <td>{{g.inspected_on|date:"d/m/y" }}</td>
            {% else %}

            <td>NA</td>
            {% endif %}
                <!-- <td>{{ g.institute_name }}</td> -->
                <!-- <td>{{ g.id }}</td> -->
                <td>{{ g.inspection_note_no }}</td>
                <td><a class="js-btn-tooltip" data-toggle="tooltip" data-placement="top" title='{{g.inspection_title}}'>
                  {{g.inspection_title|slice:":80"}}..
                </a>
              </td>
                <td>
                   
                        {% for j in g.location_item %}
                        {% if j.type == 'HQ' %}
                            <span >{{j.item}}<br></span>
                        {% endif %}
                        {% endfor %}
                    
                </td>
                <td>
                  
                        {% for j in g.location_item %}
                        {% if j.type == 'DIV' %}
                            <span >{{j.item}}<br></span>
                        {% endif %}
                        {% endfor %}
                  
                </td>

            <!-- <td>
                
                    {% for j in g.location_item %}
                    {% if j.type == 'DPT' %}
                        <span >{{j.item}}<br></span>
                    {% endif %}
                    {% endfor %}
                
            </td> -->

            <!-- <td>
                
                    {% for j in g.location_item %}
                    {% if j.type == 'LOC' %}
                        <span >{{j.item}}<br></span>
                    {% endif %}
                    {% endfor %}
                
            </td> -->
            
                <td><a type="button" class="btn " style="background-color: #0000ff; color: #fff;" href="{% url 'inspectionReportPdf' g.inspection_no %}"   target="blank" style="color: #fff;"><i class="far fa-file-alt"></i></a></td>
                <td><a type="button" class="btn " style="background-color: #0000ff; color: #fff;" href="{% url 'reciveCompReportReply' g.inspection_no %}"   style="color: #fff;"><i class="fas fa-eye"></i>  </a></td>
                <!-- <td>{{g.status}}</td> -->
               
            </tr> 
            {% endfor %}
        </tbody>

    </table>
</div>
<br>



<!-- Modal for reply-->
<div class="modal fade right" id="ReplyModal" tabindex="-1" role="dialog" aria-labelledby="ReplyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-full-width" role="document">
  <div class="modal-content modal-content-full-width">
      <div class="modal-header modal-header-full-width">
          <h5 class="modal-title" id="ReplyModalLabel"></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
          </button>
      </div>
      <div class="modal-body">
          <div class="row">
              <div class="col-2">
                  <label >Inspection No</label>
              </div> 
              <div class="col-2" >
                  <input type="text" value=""  id="ins_id" readonly class="form-control" readonly/>
              </div>
              <div class="col-2">
                  <label >Inspection Note No</label>
              </div> 
              <div class="col-2" >
                  <input type="text" value=""  id="ins_note_id" readonly class="form-control" readonly/>
              </div>
          </div>
          <!-- gunjan -->
          <div class="row">
              <div class="col-2">
                  <label>Inspection Officer</label>
              </div>
              <div class="col-2" >
                  <input type="text" value="" id="ins_officer" class="form-control" readonly/>
              </div>
              <div class="col-2">
                  <label >Officer Designation</label>
              </div> 
              <div class="col-2" >
                  <input type="text" value=""  id="ins_desig" readonly class="form-control" readonly/>
              </div>
          </div>

          <div class="row">
              <div class="col-2">
                  <label>Inspection Title</label>
              </div> 
              <div class="col-2" >
                  <input type="text" value="" class="form-control" id="ins_title" readonly/>
              </div>
              <div class="col-2">
                  <label>Inspection Date</label>
              </div>
              <div class="col-2" ><input type="text" value="" id="ins_date" class="form-control" readonly/>
              </div>
          </div>
          <table id="mytable1" class="table table-striped table-bordered table-lg ">
              <thead>
                  <tr>
                      <th>Item No</th>
                      <th>Observation</th>
                      <th>Compliance Status</th>
                      <th>Compliance</th>
                  </tr>
              </thead>
              <tbody>
                  
              </tbody>
          </table>
      </div><!--  Modal Body -->
      <div class="modal-footer modal-footer-full-width">
          <button type="button" class="btn btn-primary" onclick="save_data()">Submit</button> 
          <button type="button" class="btn btn-secondary" data-dismiss="modal" id="closereply">Close</button>
      </div>
  </div><!-- Modal-Content-->
  </div><!-- Modal-Dialog -->
  </div><!-- Modal -->


</body>   
<script>
 function refreshPage() {
            location.reload();
        
    }
  $("#zone").select2();
 
        //  // Read selected option
        //  $('#rly').click(function(){
        //    var username = $('#rly option:selected').text();
        //    var userid = $('#rly').val();
       
          
       

        //  });
 
 $("#division").select2();
 
 $('#division').click(function(){
   var username = $('#div option:selected').text();
   var userid = $('#div').val();
});

 $("#department").select2();
 
 $('#department').click(function(){
   var username = $('#department option:selected').text();
   var userid = $('#department').val();
});


</script>
                                                                                                                                                                                                                                                                                              

<script>
  function filterinspectiondata(){
            var rly=$('#zone').val();
            var dept=$('#department').val();
            var div=$('#division').val();
            var loc=$('#location').val();
                        
            var start_date=$('input#start').val();
         
            // alert(start_date);
           
            var end_date=$('input#txtDate2').val();
     
           
  }</script>

<script>
  $('#zone').change(function() {
var rly=$('#zone').val();



$.ajax({
type : 'GET',
url : "{% url 'getdiv_rly' %}",
dataType : 'json',
data : {
    'rly_data':JSON.stringify(rly_new),
   
  },
  success : function(response){
    division=response.division;
                $('#division').empty();
                $('#division').append(`<option value="">All</option>`);
                for (let i = 0; i < division.length; i++) {
                $('#division').append(`<option value="${division[i].location_code}">
                  ${division[i].location_code}-${division[i].location_type}
                              </option>`);
                          }
}
   })
   })



   $("#location").select2({
    minimumInputLength: 1,
    language: {
        inputTooShort: function() {
          return 'Please Add One or More Location';
        }
      },
    tags: [],
    ajax: {
        url: '{% url "autoFetchLocation" %}',
        dataType: 'json',
        type: "GET",
        quietMillis: 50,
        data: function (term) {
            return {
                last_val: term.term
            };
            
        },
        processResults: function (data) {
          return {
                results: $.map(data, function (item) {
                  
                    return{
                      text: item.city,
                      
                      id: item.city,
                    }
                })
            };
          },
        
        
    }
});


$(function() {

$('input[name="date_range"]').daterangepicker({
    autoUpdateInput: false,
    autoApply: true,
    maxDate: new Date(),
    locale: {
        cancelLabel: 'Clear'
    }
});

$('input[name="date_range"]').on('apply.daterangepicker', function(ev, picker) {
  $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
  $('.applyButtonClasses').click()
 
  
});

$('input[name="date_range"]').on('cancel.daterangepicker', function(ev, picker) {
    $(this).val('');
});



});


var table = $('#instituteTable').DataTable({
  "language": {
    "search": "Keyword search:"
  }
});

function getSearchValue(){
      
    let data1 = {
            zone1: JSON.stringify($('#zone').val()),
            division1: JSON.stringify($('#division').val()),
            department1: JSON.stringify($('#department').val()),
            location1: JSON.stringify($('#location').val()),
            date_range: $('#date_range').val(),
            csrfmiddlewaretoken: '{{ csrf_token }}'
                
        }
    
        $.ajax({
          type : 'POST',
          url : "{% url 'getSearchValueRecived_ajax' %}",
          dataType : 'json',
          data : data1,

          success : function(res){
            console.log(res)
            
            table.destroy()
            $('#instituteTable tbody').empty()
            content = ''
            for(i in res.mydata){
              let index = parseInt(i)+1
              let hq = ''
              let loc = ''
              let dept = ''
              let div = ''
              for(y in res.mydata[i].location_item){
                
                if(res.mydata[i].location_item[y].type == 'HQ'){
                  hq += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
                }
                else if (res.mydata[i].location_item[y].type == 'LOC'){
                  loc += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
                }
                else if (res.mydata[i].location_item[y].type == 'DIV'){
                  div += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
                }
                else if (res.mydata[i].location_item[y].type == 'DPT'){
                  dept += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
                }
            
                  
              } 


              content += '<tr>'
              content += '<td>'+ index +'</td>'
              content += '<td>'+ formatDate(res.mydata[i].inspected_on) +'</td>'
              content += '<td>'+ res.mydata[i].inspection_note_no +'</td>'
              content += '<td><a class="js-btn-tooltip" data-toggle="tooltip" data-placement="top" title="'+ res.mydata[i].inspection_title +'">'+ res.mydata[i].inspection_title.slice(0, 50) +'</a></td>'
              
                 
              content +='<td>'+hq+'</td>'
              content +='<td>'+div+'</td>'
              // content +='<td>'+dept+'</td>'
              // content +='<td>'+loc+'</td>'

              

              
              
              content += '<td><a type="button" class="btn "  style="background-color: #0000ff; color: #fff;"  href="/inspectionReportPdf/'+res.mydata[i].inspection_no + '"   target="blank"><i class="far fa-file-alt"></i></a></td>'
              content += '<td><a type="button" class="btn "  style="background-color: #0000ff; color: #fff;"  href="/reciveCompReportReply/'+res.mydata[i].inspection_no + '"   target="blank"><i class="fas fa-eye"></i> </a></td>'
              
              

              content += '</tr>'
              
            }
            
            $('#instituteTable tbody').append(content)
            table = $('#instituteTable').DataTable({
                          "language": {
                "search": "Keyword search:"
              }
              
            });
            $('.js-btn-tooltip').tooltip();
          }
      });
}



function formatDate(date) {
    var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();

    if (month.length < 2) 
        month = '0' + month;
    if (day.length < 2) 
        day = '0' + day;
    let newyear = String(year).slice(2, 5)
    return [day,month,newyear].join('-');
}

$(document).ready(function(){
  
  $('.js-btn-tooltip').tooltip();
 
  $('.js-btn-tooltip--custom-alt').tooltip({
    customClass: 'tooltip-custom-alt'
  });
  
});


</script>

{% endblock %}  