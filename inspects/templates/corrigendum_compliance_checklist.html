{% extends 'base.html' %} 
{% block content %}
{% load static %}
   <head>
    <link rel="stylesheet" type="text/css" href="{% static '/css/forms_common.css' %}" />    
    <script type="text/javascript">
      $(".sidebar").addClass('close');
    </script>
    </head> 
    
  
<body>
  <h3 class="report_heading">Reverted Compliance of My Inspections</h3> 
  
  
  
  <div class="container">
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'success' %}
              <div class="alert alert-success">
                <strong>Success </strong>{{ message }}
              </div>
            {% elif message.tags == 'error' %}
              <div class="alert alert-danger">
                <strong>Error </strong>{{ message }}
              </div>
            {% elif message.tags == 'info' %}
              <div class="alert alert-info">
                <strong>Info </strong>{{ message }}
              </div>
            {% else %}
            
            {% endif %}
           
        {% endfor %}
    {% endif %}
  </div>
  <br>

 
  

  <!-- <div class="col-md-12" style="font-family:'Lato', sans-serif"> -->
 

<div class="container">
  <div class="inpt-container" id="container1" style="padding-bottom:10px;">    
    
    <form  method="POST" class="d-inline " >
          
      {% csrf_token %}
  
     <div class="row" id="row1" style="font-family: 'Lato', sans-serif;font-size: 1em; margin-left: 2em;">

      <div  class="col" >
        <label for="location" class="lbl-caption">Date Range</label>
        <input id="date_range" class="form-control sel-control" name="date_range" autocomplete="off" placeholder="dd/mm/yy - dd/mm/yy" >
        
       
      </div>

      <div class="col"  >
          <label for="Zone" class="lbl-caption" >Railway/Organization</label>
          <select class="form-control sel-control" id="zone" data-placeholder="Rly./Org Wise..." name="zone" class="custom-select"
              multiple ><span style="color:red;font-weight:bold">*</span>
              <option value="" disabled>select</option>
              {% for z in Zone %}
              <option value="{{z}}">{{z}}</option>
              {% endfor %}
  
          </select>
      </div>
  
     
        
      <div class="col">
          <label for="division" class="lbl-caption">Division/Unit</label>
          <select class="form-control sel-control" id="division" data-placeholder="Div./Unit Wise..." name="division" class="custom-select" style="max-width:100%;"
          multiple><span style="color:red;font-weight:bold">*</span>
      
                  <option value="" disabled>select</option>
                  {% for d in division %}
                  <option value="{{d.location_code}}">{{d.location_code}}</option>
                {% endfor %}
      
              </select>
          
      </div>

      <div class="col" hidden>
        <label for="division" class="lbl-caption">Department</label>
        <select class="form-control sel-control" id="department"  name="department" class="custom-select" style="max-width:100%;" multiple>
      
                <option value="" disabled>select</option>
                {% for d in department %}
                <option value="{{d.department_name}}">{{d.department_name}}</option>
                {% endfor %}
      
        </select>
        
      </div>
  
      <div  class="col" hidden>
        <label for="location" class="lbl-caption">Location </label><br>
        <div>
          <select name="location" id="location" class="form-control sel-control"  multiple>
      
          </select>
        </div>
        
      </div>
  
  
      <div  class="col" >
        <div class="btn-toolbar" role="toolbar" >
          <div class="btn-group mr-2" role="group" style="margin-top:30px;" >   
        
    
          <button  type="button"  name="zone_loc_submit" class="btn btn-warning btn-sm" id="insp_submit" onclick="search_data()">Continue</button>
          <a class="btn btn-secondary btn-sm" href="/corrigendum_compliance_checklist">Reset</a>  
          <a type="button" class="btn btn-danger btn-sm"  target="_blank" href="{% url 'corrigendum_compliance_checklist_pdf'%}" hidden ><i class="fa-solid fa-file-pdf"></i> PDF</a>    
        </div>
        </div>
      </div>

     </div>
    
    </form>
  </div>

</div>

  
  

   <div class="container" style="font-family:'Lato', sans-serif; overflow-x: auto; ">
    <table id="instituteTable" class=" table-striped table-bordered table-sm table-data" >
    <thead  style="background-color: #343a40;white-space: nowrap;color:white;text-align: left;">
          
            
        <th>S.No.</th>
        <th style="display:none;"></th>
        <th >Date of Insp.</th>
        <th >Insp. Note No.</th>
        <th >Insp. Type</th>
        <th >Insp. Title</th>
        <th >Rly./Org.</th>
        <th >Div./Unit</th>
        <!-- <th >Department</th>
        <th >Location</th> -->
        
        <th >Insp. Note</th>
        <th >Rec'd Reply</th>
        
        </thead>
        <tbody>

            {% for g in mydata %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td style="display:none;">{{g.inspected_on | date:'Y-m-d'}}</td>
                <td>{{g.inspected_on|date:"d/m/y" }}</td>
                <!-- <td>{{ g.institute_name }}</td> -->
                <!-- <td>{{ g.id }}</td> -->
                <td>{{ g.inspection_note_no }}</td>
                <td>General</td>
                <td><a class="js-btn-tooltip" data-toggle="tooltip" data-placement="top" title='{{g.inspection_title}}'>
                  {{g.inspection_title|truncatechars:100}}
                </a>
              </td>
                
                <td>{% for j in g.location_item %}
                  {% if j.type == 'HQ' %}
                      <span >{{j.item}}<br></span>
                  {% endif %}
                  {% endfor %}
                </td>

                <td>{% for j in g.location_item %}
                        {% if j.type == 'DIV' %}
                            <span >{{j.item}}<br></span>
                        {% endif %}
                        {% endfor %}
                      
                </td>
                    <!-- <td>
                
                      {% for j in g.location_item %}
                      {% if j.type == 'DPT' %}
                          <span >{{j.item}}<br></span>
                      {% endif %}
                      {% endfor %}
                  
                    </td> -->
                    <!-- <td>
                
                      {% for j in g.location_item %}
                      {% if j.type == 'LOC' %}
                          <span >{{j.item}}<br></span>
                      {% endif %}
                      {% endfor %}
                  
                    </td> -->

                

               
                
                
               
                
                <td><a type="button" class="btn btn-outline-primary btn-sm" href="{% url 'inspectionReportHtml' g.inspection_no %}" target="fileinsp"><i class="far fa-file-alt"></i></a></td>
                <td><a type="button" class="btn btn-outline-danger btn-sm" href="{% url 'corrigendumReportReply' g.inspection_no %}"  target="_blank"><i class="fas fa-eye"></i></a>
                <a type="button" class="btn btn-outline-danger btn-sm" href="{% url 'inspectionReportReply_pdf' g.inspection_no %}"  target="_blank"><i class="far fa-file-alt"></i></a></td>
                <!-- <td>{{g.status}}</td> -->
               
            </tr> 
            {% endfor %}
            {% for i in phase2 %}
            <tr style="text-align:left">
                <td style="width:5%">{{i.sr_no}}</td>
                <td style="display:none;">{{i.eitemid__einspno__inspected_on| date:'Y-m-d'}}</td>
                <td style="width:10%">{{i.eitemid__einspno__inspected_on | date:'d/m/y'}}</td>
                <td style="width:10%">{{i.eitemid__einspno__inspection_note_no}}</td>
                <td style="width:10%">{{i.eitemid__einspno__instypeid__name}}</td>
                <td style="width:45%;"><a class="js-btn-tooltip"  data-toggle="tooltip" data-placement="top" title='{{i.eitemid__einspno__inspection_title}}'>{{i.eitemid__einspno__inspection_title|truncatechars:100}}</a></td>
                
                <td>
                  {% for j in i.einsprly %}
                        <span >{{j.location_code}}<br></span>
                      {% endfor %}
                      </td>
                <td> {% for j in i.einspdiv %}
                  <span >{{j.location_code}}<br></span>
                {% endfor %}
                </td>
                <td style="width:5%">
                    <a type="button"  class="btn btn-outline-primary btn-sm " href="{% url 'pdfDetails' %}?id={{i.eitemid__einspno}}"  id=/{{i.eitemid__einspno}} target="_blank"><i class="far fa-file-alt"></i></a>
                </td>
                <td style="width:5%">
                  <a type="button" class="btn btn-outline-danger btn-sm" href="{% url 'corrigendumReportReply_phase2' i.eitemid__einspno %}"  target="_blank"><i class="fas fa-eye"></i></a>
                  <a type="button" class="btn btn-outline-danger btn-sm" href="{% url 'view_compliance_phase2_pdf' i.eitemid__einspno %}"  target="_blank"><i class="far fa-file-alt"></i></a>
                    <!-- <button type="button" class="btn btn-outline-warning btn-sm " data-toggle="modal" data-target="#RevertModal" id={{i.eitemid__einspno}} onclick="revert(this,'2')">Remarks</button> -->
                </td>
            </tr>
        {% endfor %}
        </tbody>

    </table>
  </div>






<!-- Modal for reply-->
<div class="modal fade right" id="ReplyModal" tabindex="-1" role="dialog" aria-labelledby="ReplyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-full-width" role="document">
  <div class="modal-content modal-content-full-width">
      <div class="modal-header modal-header-full-width">
          <h5 class="modal-title" id="ReplyModalLabel"></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
          </button>
      </div>
      <div class="modal-body">
          <div class="row">
              <div class="col-2">
                  <label >Inspection No</label>
              </div> 
              <div class="col-2" >
                  <input type="text" value=""  id="ins_id" readonly class="form-control" readonly/>
              </div>
              <div class="col-2">
                  <label >Inspection Note No</label>
              </div> 
              <div class="col-2" >
                  <input type="text" value=""  id="ins_note_id" readonly class="form-control" readonly/>
              </div>
          </div>
          <!-- gunjan -->
          <div class="row">
              <div class="col-2">
                  <label>Inspection Officer</label>
              </div>
              <div class="col-2" >
                  <input type="text" value="" id="ins_officer" class="form-control" readonly/>
              </div>
              <div class="col-2">
                  <label >Officer Designation</label>
              </div> 
              <div class="col-2" >
                  <input type="text" value=""  id="ins_desig" readonly class="form-control" readonly/>
              </div>
          </div>

          <div class="row">
              <div class="col-2">
                  <label>Inspection Title</label>
              </div> 
              <div class="col-2" >
                  <input type="text" value="" class="form-control" id="ins_title" readonly/>
              </div>
              <div class="col-2">
                  <label>Inspection Date</label>
              </div>
              <div class="col-2" ><input type="text" value="" id="ins_date" class="form-control" readonly/>
              </div>
          </div>
          <table id="mytable1" class="table table-striped table-bordered table-lg ">
              <thead>
                  <tr>
                      <th>Item No</th>
                      <th>Observation</th>
                      <th>Compliance Status</th>
                      <th>Compliance</th>
                  </tr>
              </thead>
              <tbody>
                  
              </tbody>
          </table>
      </div><!--  Modal Body -->
      <div class="modal-footer modal-footer-full-width">
          <button type="button" class="btn btn-primary" onclick="save_data()">Submit</button> 
          <button type="button" class="btn btn-secondary" data-dismiss="modal" id="closereply">Close</button>
      </div>
  </div><!-- Modal-Content-->
  </div><!-- Modal-Dialog -->
  </div><!-- Modal -->


</body>   
<script>
  function search_data()
  {

   
      var div_id = $('#division').val();
      var rly_id = $('#zone').val();
      var date_range = $('#date_range').val();
      var table = $('#instituteTable').DataTable();
      if (date_range != '') {
            date_range = date_range.split(' - ');
            let sd = date_range[0].split('/');
            let ed = date_range[1].split('/');
            let sdFormatted = '20' + sd[2] + '-' + sd[1] + '-' + sd[0];
            let edFormatted = '20' + ed[2] + '-' + ed[1] + '-' + ed[0];
            $.fn.dataTable.ext.search.push(
              function(settings, data, dataIndex) {
                var date = data[1]; // Assuming date column is index 1
                var dateFormatted = date;
                if (dateFormatted >= sdFormatted && dateFormatted <= edFormatted) {
                  return true; 
                }
                return false; 
              }
            );
          }
      
      if( rly_id.length == 0 && div_id.length == 0 && date_range == '')
      {
          alert('Select atleast one to search');
          return false;
      }
      else if( rly_id.length != 0 && div_id.length == 0)
      {
          var searches = rly_id.map(function(id) {
            return '^' + id + '$'; 
          });
          var combinedSearchRly = searches.join('|');
          table.column(6).search(combinedSearchRly, true, false).draw();
          return false;
      }
      else if( rly_id.length == 0 && div_id.length != 0)
      {
        
          var searches = div_id.map(function(id) {
            return '^' + id + '$'; 
          });
          var combinedSearchDiv = searches.join('|');

          table.column(7).search(combinedSearchDiv, true, false).draw();
          return false;
      }
      else if( rly_id.length != 0 && div_id.length != 0)
      {
        var searches = rly_id.map(function(id) {
            return '^' + id + '$'; 
          });
          var combinedSearchRly = searches.join('|');
          table.column(6).search(combinedSearchRly, true, false);
          searches = div_id.map(function(id) {
            return '^' + id + '$'; 
          });
          var combinedSearchDiv = searches.join('|');

          table.column(7).search(combinedSearchDiv, true, false).draw();
          return false;
      }
      else{
        table.draw();
      }
    }
 

 function refreshPage() {
            location.reload();
        
    }
  $("#zone").select2();
 
         // Read selected option
         $('#rly').click(function(){
           var username = $('#rly option:selected').text();
           var userid = $('#rly').val();
       
          
       

         });
 
 $("#division").select2();
 
 $('#division').click(function(){
   var username = $('#div option:selected').text();
   var userid = $('#div').val();
});

 $("#department").select2();
 
 $('#department').click(function(){
   var username = $('#department option:selected').text();
   var userid = $('#department').val();
});


</script>
                                                                                                                                                                                                                                                                                              

<script>
  function filterinspectiondata(){
            var rly=$('#zone').val();
            var dept=$('#department').val();
            var div=$('#division').val();
            var loc=$('#location').val();
                        
            var start_date=$('input#start').val();
            
            // alert(start_date);
           
            var end_date=$('input#txtDate2').val();
      
           
  }</script>
  
<script>
  $('#zone').change(function() {
var rly=$('#zone').val();
// alert(rly)

$.ajax({
type : 'GET',
url : "{% url 'getdiv_rly' %}",
dataType : 'json',
data : {
    'rly_data':JSON.stringify(rly),
    
   
  },
  success : function(response){
    console.log(response)
    division=response.division;
                $('#division').empty();
                $('#division').append(`<option value="">All</option>`);
                for (let i = 0; i < division.length; i++) {
                $('#division').append(`<option value="${division[i].location_code}">
                  ${division[i].location_code}
                              </option>`);
                          }
}
   })
   })




   $("#location").select2({
    minimumInputLength: 1,
    language: {
        inputTooShort: function() {
          return 'Please Add One or More Location';
        }
      },
    tags: [],
    ajax: {
        url: '{% url "autoFetchLocation" %}',
        dataType: 'json',
        type: "GET",
        quietMillis: 50,
        data: function (term) {
            return {
                last_val: term.term
            };
            
        },
        processResults: function (data) {
          return {
                results: $.map(data, function (item) {
             
                    return{
                      text: item.city,
                      
                      id: item.city,
                    }
                })
            };
          },
        
        
    }
});




$(function() {

    $('input[name="date_range"]').daterangepicker({
        autoUpdateInput: false,
        autoApply: true,
        maxDate: new Date(),
        locale: {
            cancelLabel: 'Clear'
        }
    });

    $('input[name="date_range"]').on('apply.daterangepicker', function(ev, picker) {
      $(this).val(picker.startDate.format('DD/MM/YY') + ' - ' + picker.endDate.format('DD/MM/YY'));
      $('.applyButtonClasses').click()
    
      
    });

    $('input[name="date_range"]').on('cancel.daterangepicker', function(ev, picker) {
        $(this).val('');
    });



});


var table = $('#instituteTable').DataTable({
  "language": {
    "search": "Keyword search:"
  },
  "aaSorting": [[ 1, "desc" ]] ,
  "aoColumns": [
            null,
            null,
            { "sType": "date-uk" },
            null,
            null,
            null,
            null,
            null,
            null,
            null
           
        ],
                "fnRowCallback" : function(nRow, aData, iDisplayIndex){
                $("td:first", nRow).html(iDisplayIndex +1);
               return nRow;
            }
});

function getSearchValue(){
  

    let data1 = {
            zone1: JSON.stringify($('#zone').val()),
            division1: JSON.stringify($('#division').val()),
            department1: JSON.stringify($('#department').val()),
            location1: JSON.stringify($('#location').val()),
            date_range: $('#date_range').val(),
            csrfmiddlewaretoken: '{{ csrf_token }}'
                
        }
    
        $.ajax({
          type : 'POST',
          url : "{% url 'getSearchValueCorrigendum_ajax' %}",
          dataType : 'json',
          data : data1,

          success : function(res){
        
            
            table.destroy()
            $('#instituteTable tbody').empty()
            content = ''
            for(i in res.mydata){
              let index = parseInt(i)+1
              let hq = ''
              let loc = ''
              let dept = ''
              let div = ''
              for(y in res.mydata[i].location_item){
                
                if(res.mydata[i].location_item[y].type == 'HQ'){
                  hq += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
                }
                else if (res.mydata[i].location_item[y].type == 'LOC'){
                  loc += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
                }
                else if (res.mydata[i].location_item[y].type == 'DIV'){
                  div += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
                }
                else if (res.mydata[i].location_item[y].type == 'DPT'){
                  dept += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
                }
            
                  
              } 


              content += '<tr>'
              content += '<td>'+ index +'</td>'
              content += `<td style="display:none;">${res.mydata[i].inspected_on}</td>`
              content += '<td>'+ formatDate(res.mydata[i].inspected_on) +'</td>'
              content += '<td>'+ res.mydata[i].inspection_note_no +'</td>'
              content += '<td>General</td>'
              content += '<td><a class="js-btn-tooltip" data-toggle="tooltip" data-placement="top" title="'+ res.mydata[i].inspection_title +'">'+ res.mydata[i].inspection_title.slice(0, 100) +'..</a></td>'
              
                 
              content +='<td>'+hq+'</td>'
              content +='<td>'+div+'</td>'
              // content +='<td>'+dept+'</td>'
              // content +='<td>'+loc+'</td>'

              

              
              
              content += '<td><a type="button" class="btn btn-outline-primary btn-sm " color: #fff;"  href="/inspectionReportHtml/'+res.mydata[i].inspection_no + '"   target="blank"><i class="far fa-file-alt"></i></a></td>'
              content += '<td><a type="button" class="btn btn-outline-danger btn-sm" color: #fff;"  href="/reciveCompReportReply/'+res.mydata[i].inspection_no + '"   target="blank"><i class="fas fa-eye"></i> </a>&nbsp;<a type="button" class="btn btn-outline-danger btn-sm" color: #fff;"  href="/inspectionReportReply_pdf/'+res.mydata[i].inspection_no + '"   target="blank"><i class="far fa-file-alt"></i></a></td>'
              
              

              content += '</tr>'
              
            }
            let phase2data = res.phase2;
            for (let i = 0; i < phase2data.length; i++) {
              content += '<tr>'
              content += '<td>'+ i + 1 +'</td>'
              content += `<td style="display:none;">${phase2data[i]['inspected_on']}</td>`
              content += '<td>'+ formatDate(phase2data[i]['inspected_on']) +'</td>'
              content += '<td>'+ phase2data[i]['inspection_note_no'] +'</td>'
              content += `<td>${phase2data[i]['instypeid__name']}</td>`
              content += '<td><a class="js-btn-tooltip" data-toggle="tooltip" data-placement="top" title="'+ phase2data[i]['inspection_title'] +'">'+ truncateString(phase2data[i]['inspection_title'], 100) +'</a></td>'
              
              content += `<td>`;
				      for(j in phase2data[i]['einsprly'])
                 {
                  content += phase2data[i]['einsprly'][j]['location_code']+'<br>';
                 }
                 
                 content += `</td><td width=7%>`;
                  for(j in phase2data[i]['einspdiv'])
                 {
                  content += phase2data[i]['einspdiv'][j]['location_code']+'<br>';
                 }
              
              content +=`<td style="width:5%">
                    <a type="button"  class="btn btn-outline-primary btn-sm " href="/pdfDetails/?id=${phase2data[i]['einspno']}"  id=/${phase2data[i]['einspno']} target="_blank"><i class="far fa-file-alt"></i></a>
                </td>
                <td style="width:5%">
                  <a type="button" class="btn btn-outline-danger btn-sm" href="/corrigendumReportReply_phase2/${phase2data[i]['einspno']}"  target="_blank"><i class="fas fa-eye"></i></a>
                  <a type="button" class="btn btn-outline-danger btn-sm" href="/view_compliance_phase2_pdf/${phase2data[i]['einspno']}"  target="_blank"><i class="far fa-file-alt"></i></a>
                </td>`
              content += '</tr>'
            }
            
            $('#instituteTable tbody').append(content)
            table = $('#instituteTable').DataTable({
                          "language": {
                "search": "Keyword search:"
              },
              "aaSorting": [[ 1, "desc" ]] ,
              "aoColumns": [
            null,
            null,
            { "sType": "date-uk" },
            null,
            null,
            null,
            null,
            null,
            null,
            null
        ],
                "fnRowCallback" : function(nRow, aData, iDisplayIndex){
                $("td:first", nRow).html(iDisplayIndex +1);
               return nRow;
            }
            });
            $('.js-btn-tooltip').tooltip();
          }
      });
}



function formatDate(date) {
    var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();

    if (month.length < 2) 
        month = '0' + month;
    if (day.length < 2) 
        day = '0' + day;
    let newyear = String(year).slice(2, 5)
    return [day,month,newyear].join('-');
}


$(document).ready(function(){
  
  $('.js-btn-tooltip').tooltip();
 
  $('.js-btn-tooltip--custom-alt').tooltip({
    customClass: 'tooltip-custom-alt'
  });
  
});
</script>
<script>
  jQuery.extend( jQuery.fn.dataTableExt.oSort, {
    "date-uk-pre": function ( a ) {
        var ukDatea = a.split('/');
        return (ukDatea[2] + ukDatea[1] + ukDatea[0]) * 1;
    },

    "date-uk-asc": function ( a, b ) {
        return ((a < b) ? -1 : ((a > b) ? 1 : 0));
    },

    "date-uk-desc": function ( a, b ) {
        return ((a < b) ? 1 : ((a > b) ? -1 : 0));
    }
    } );

    function truncateString(str, num) {
  if (str.length > num) {
    return str.slice(0, num) + "...";
  } else {
    return str;
  }
}
</script>

{% endblock %}  