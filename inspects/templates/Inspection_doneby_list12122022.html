{% extends 'base.html' %} 
{% load static %}
{% block content %}

<head>
  <link rel="stylesheet" type="text/css" href="{% static '/css/forms_common.css' %}" />    
</head>
    
  
<body>
  <h3 class="report_heading">Inspections Done by {{desig}}</h3>     
  
   
   
    <div class="container">
      {% if messages %}
          {% for message in messages %}
              {% if message.tags == 'success' %}
                <div class="alert alert-remove alert-success alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
              {% elif message.tags == 'error' %}
                
                <div class="alert alert-remove alert-danger alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
              {% elif message.tags == 'info' %}
                
                <div class="alert alert-remove alert-info alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
              {% else %}
              
              {% endif %}
             
          
          {% endfor %}
      {% endif %}
    </div>
  
  
    <br>
  <div class="container">

 
  <div class=" inpt-container" id="container1" style="padding-bottom:10px;">
      
  <form  method="POST" class="d-inline " >
          
        {% csrf_token %}
    
    <div class="row" id="row1" style="font-family: 'Lato', sans-serif;font-size: 1em; margin-left: 2em;">

        <div  class="col" >
          <label for="location" class="lbl-caption">Date Range</label>
          <input id="date_range" class="form-control" name="date_range" autocomplete="off" placeholder="dd/mm/yy - dd/mm/yy" >
        </div>

        <div class="col"  >
            <label for="Zone" class="lbl-caption">Rly./Org. Wise </label>
            <select class="form-control" id="zone" data-placeholder="Rly./Org Wise..." name="zone" class="custom-select"
                multiple ><span style="color:red;font-weight:bold">*</span>
                <option value="" disabled>select</option>
                {% for z in Zone %}
                <option value="{{z}}">{{z}}</option>
                {% endfor %}
    
            </select>
        </div>
    
       
       
    <div class="col">
        <label for="division" class="lbl-caption">Division/Unit</label>
        <select class="form-control" id="division" data-placeholder="Div./Unit Wise..." name="division" class="custom-select" style="max-width:100%;"
        multiple><span style="color:red;font-weight:bold">*</span>
    
                <option value="" disabled>select</option>
                {% for d in division %}
                    <option value="{{d.location_code}}">{{d.location_code}}-{{d.location_type}}</option>
                    {% endfor %}
    
            </select>
        
    </div>

    <div class="col" hidden>
      <label for="division" class="lbl-caption">Department </label>
      <select class="form-control" id="department"  name="department" class="custom-select" style="max-width:100%;" multiple>
    
              <option value="" disabled>select</option>
              {% for d in department %}
              <option value="{{d.department_name}}">{{d.department_name}}</option>
              {% endfor %}
    
      </select>
      
    </div>
    
    <div  class="col" hidden>
      <label for="location" class="lbl-caption">Location </label><br>
      <div>
        <select name="location" id="location" class="form-control"  multiple>
    
        </select>
      </div>
      
    </div>
    
    <div  class="col" >
      <div class="btn-toolbar" role="toolbar" >
        <div class="btn-group mr-2" role="group" style="margin-top:30px;" >

     
      <button  type="button"  name="zone_loc_submit" class="btn btn-warning btn-sm" id="insp_submit" onclick="getSearchValue()">Continue</button>
      <button  type="button"  class="btn btn-secondary btn-sm" id="insp_clear" onclick="refreshPage()">Reset</button>


       </div>
    </div> 
    </div>


    </div>
  
      
  </form>
    
  </div>

  </div>
    
    <div class="container" style="font-family:'Lato', sans-serif; overflow-x: auto;">
    <div class="modern" style="font-family:'Lato', sans-serif">
      <table class="table table-striped table-bordered table-data" id="instituteTable" >
          <thead
              style="background-color: #343a40;white-space: nowrap; color:white;text-align: left;">
              <th style="width: 5%;">S.No.</th>
              <th style="width: 5%;">Insp. Date</th>
              <th style="width: 20%;">Insp. Note No.</th>
              
              <th style="width: 45%;">Insp. Title</th>
              <th style="width: 5%;">Rly./Org.</th>
              <th style="width: 5%;">Div./Unit</th>
             
              <th style="width: 5%;">% Compliance</th>
              <th style="width: 5%;">Insp. Note</th>

              <th style="width: 5%;">Rec'd Reply</th>
             
          </thead>
          <tbody>
  
              {% for g in mydata %}
              <tr>
                  <td>{{ forloop.counter }}</td>

                  {% if g.inspected_on|date:"d/m/y" %}
  
                  <td>{{g.inspected_on|date:"d/m/y" }}</td>
  
                  {% else %}
                  <td>NA</td>
                  {% endif %}

                  <td>{{ g.inspection_note_no }}</td>
                  <td style="overflow-wrap: break-word;">

                    <a  class="js-btn-tooltip" data-toggle="tooltip" data-placement="top" title='{{g.inspection_title}}'>
                      {{g.inspection_title|truncatechars:20}}
                    </a>
                  </td>

                  
                  
                  <td>
                    
                   
                      {% for j in g.location_item %}
                        {% if j.type == 'HQ' %}
                        <span >{{j.item}}<br></span>
                        {% endif %}
                      {% endfor %}
                   
  
                  </td>
                  <td>
                    
                      {% for j in g.location_item %}
                        {% if j.type == 'DIV' %}
                        <span style="white-space: nowrap;">{{j.item}}<br></span>
                           
                        {% endif %}
                      {% endfor %}
                    
                  </td>
                  <!-- <td>
                   
                      {% for j in g.location_item %}
                        {% if j.type == 'DPT' %}
                        <span >{{j.item}}<br></span>
                        {% endif %}
                      {% endfor %}
                    
                  </td>
                  <td>
                    
                      {% for j in g.location_item %}
                        {% if j.type == 'LOC' %}
                        <span >{{j.item}}<br></span>
                        {% endif %}
                      {% endfor %}
                    
                  </td> -->
                 
                
                  
                  

                  <td>{{g.persentage}}</td>
                  <td ><a type="button" class="btn btn-outline-primary btn-sm" href="{% url 'inspectionReportPdf' g.inspection_no %}"   target="blank"><i class="far fa-file-alt"></i></a></td>
                    {% if g.persentage == 100 %}
                    <td><a type="button" class="btn btn-outline-success btn-sm"  href="{% url 'inspectionReportReply' g.inspection_no %}"  target="blank" style="text-align: center;"><i class="fas fa-eye"></i></a></td>
                    
                    {% else %}
                    <td><a type="button" class="btn btn-outline-danger btn-sm"  href="{% url 'inspectionReportReply' g.inspection_no %}"  target="blank" style="text-align: center;"><i class="fas fa-eye"></i></a></td>
                    {% endif %}
              </tr> 
              {% endfor %}
          </tbody>
  
      </table>
    </div>
    </div>
  <br>
  
  
  
  </body>   
  <script>
    function refreshPage() {
            location.reload();
        
    }
    $("#zone").select2();
   
           // Read selected option
           $('#rly').click(function(){
             var username = $('#rly option:selected').text();
             var userid = $('#rly').val();
         
            
         
  
           });
   
   $("#division").select2();
   
   $('#division').click(function(){
     var username = $('#div option:selected').text();
     var userid = $('#div').val();
  });
  
   $("#department").select2();
   
   $('#department').click(function(){
     var username = $('#department option:selected').text();
     var userid = $('#department').val();
  });
  
  
  </script>
                                                                                                                                                                                                                                                                                                
  
  <script>
    // function filterinspectiondata(){
    //           var rly=$('#zone').val();
    //           var dept=$('#department').val();
    //           var div=$('#division').val();
    //           var loc=$('#location').val();
    //           // alert(rly);
    //           // alert(loc);
    //           // alert(dept);
    //           // alert(div);            
    //           var start_date=$('input#start').val();
    //         
    
    //           // alert(start_date);
             
    //           var end_date=$('input#txtDate2').val();
    //        
    
             
    // }
    
    </script>
 
  <script>
    $('#zone').change(function() {
  var rly=$('#zone').val();
  
  data={
    'rly':rly,
    
  }
  
  $.ajax({
  type : 'GET',
  url : "{% url 'getdiv_rly' %}",
  dataType : 'json',
  data : data,
  
  success : function(response){
    division=response.division;
                $('#division').empty();
                $('#division').append(`<option value="">All</option>`);
                for (let i = 0; i < division.length; i++) {
                $('#division').append(`<option value="${division[i]}">
                                   ${division[i]}
                              </option>`);
                            }
  }
     })
     })
  
  
  
     $("#location").select2({
      minimumInputLength: 1,
      language: {
          inputTooShort: function() {
            return 'Search Location';
          }
        },
      tags: [],
      ajax: {
          url: '{% url "autoFetchLocation" %}',
          dataType: 'json',
          type: "GET",
          quietMillis: 50,
          data: function (term) {
              return {
                  last_val: term.term
              };
          
              
          },
          processResults: function (data) {
            return {
                  results: $.map(data, function (item) {
                    
                    
                      return{
                        text: item.city,
                        
                        id: item.city,
                      }
                  })
              };
            },
          
          
      }
  });



$(function() {

$('input[name="date_range"]').daterangepicker({
    autoUpdateInput: false,
    autoApply: true,
    maxDate: new Date(),
    locale: {
        cancelLabel: 'Clear'
    }
});

$('input[name="date_range"]').on('apply.daterangepicker', function(ev, picker) {
  $(this).val(picker.startDate.format('DD/MM/YY') + ' - ' + picker.endDate.format('DD/MM/YY'));
  $('.applyButtonClasses').click()
 
  
});

$('input[name="date_range"]').on('cancel.daterangepicker', function(ev, picker) {
    $(this).val('');
});



});




window.setTimeout(function() {

$(".alert-remove").slideUp(100, function() {
    $(this).remove();
});
}, 2000);



var table = $('#instituteTable').DataTable({
  
  "language": {
    "search": "Keyword search:"
  },
  
});
  table.$('tr').tooltip( {
        placement : '',
        html : true
      })

function getSearchValue(){
  
  
   
   
       
   let data1 = {
           zone1: JSON.stringify($('#zone').val()),
           division1: JSON.stringify($('#division').val()),
           department1: JSON.stringify($('#department').val()),
           location1: JSON.stringify($('#location').val()),
           date_range: $('#date_range').val(),
           csrfmiddlewaretoken: '{{ csrf_token }}'
               
       }
   
       $.ajax({
         type : 'POST',
         url : "{% url 'getSearchValue_ajax' %}",
         dataType : 'json',
         data : data1,

         success : function(res){
      
           
           table.destroy()
           $('#instituteTable tbody').empty()
           content = ''
           for(i in res.mydata){
             let index = parseInt(i)+1
             let hq = ''
             let loc = ''
             let dept = ''
             let div = ''
             for(y in res.mydata[i].location_item){
               
               if(res.mydata[i].location_item[y].type == 'HQ'){
                 hq += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
               }
               else if (res.mydata[i].location_item[y].type == 'LOC'){
                 loc += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
               }
               else if (res.mydata[i].location_item[y].type == 'DIV'){
                 div += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
               }
               else if (res.mydata[i].location_item[y].type == 'DEPT'){
                 dept += '<span>' +res.mydata[i].location_item[y].item+'<br></span>'
               }
           
                 
             } 


             content += '<tr>'
             content += '<td>'+ index +'</td>'
             content += '<td>'+ formatDate(res.mydata[i].inspected_on) +'</td>'
             content += '<td>'+ res.mydata[i].inspection_note_no +'</td>'
             content += '<td><a class="js-btn-tooltip" data-toggle="tooltip" data-placement="top" title="'+ res.mydata[i].inspection_title +'">'+ truncateString(res.mydata[i].inspection_title, 20) +'</a></td>'
             
                
             content +='<td>'+hq+'</td>'
             content +='<td>'+div+'</td>'
             // content +='<td>'+dept+'</td>'
             // content +='<td>'+loc+'</td>'

            
             
             content +='<td>'+res.mydata[i].persentage+'</td>'
             content += '<td><a type="button" class="btn btn-outline-primary btn-sm"    href="/inspectionReportPdf/'+res.mydata[i].inspection_no + '"   target="blank"><i class="far fa-file-alt"></i></a></td>'
             
             if(res.mydata[i].persentage == 100){
               content += '<td><a type="button" class="btn btn-outline-success btn-sm" href="/inspectionReportReply/'+res.mydata[i].inspection_no + '"  target="blank" style="text-align: center;"><i class="fas fa-eye"></i></a></td>'
             }
             else{
               content += '<td><a type="button" class="btn btn-outline-danger btn-sm"  href="/inspectionReportReply/'+res.mydata[i].inspection_no + '"  target="blank" style="text-align: center;"><i class="fas fa-eye"></i></a></td>'
             }
             
             
             

             content += '</tr>'
             
           }
           
           $('#instituteTable tbody').append(content)
           table = $('#instituteTable').DataTable({
                         "language": {
               "search": "Keyword search:"
             }
             
           });
           $('.js-btn-tooltip').tooltip();
         }
     });
}

function truncateString(str, num) {
  if (str.length > num) {
    return str.slice(0, num) + "...";
  } else {
    return str;
  }
}

function formatDate(date) {
    var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();

    if (month.length < 2) 
        month = '0' + month;
    if (day.length < 2) 
        day = '0' + day;
    let newyear = String(year).slice(2, 5)
    return [day,month,newyear].join('-');
}

//for tooltip
$(document).ready(function(){
  
  $('.js-btn-tooltip').tooltip();
 
 
});


</script>
  
  {% endblock %}  