{% extends 'base.html' %} 
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FootPlate Report</title>
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous"> -->
    <script src="{% static '/js/jquery-3.4.1.min.js' %}" ></script>
    <script src="{% static '/js/popper.min.js' %}" ></script>
    <script src="{% static '/js/Chart.min.js' %}"></script>
    <script src="{% static '/js/jquery-3.3.1.slim.min.js' %}" ></script>
    <script src="{% static '/js/bootstrap.min.js' %}" ></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="{% static '/js/jquery-ui.js' %}"></script>
    <script src="{% static '/js/jquery-1.12.4.js' %}"></script>
    <script src="{% static '/js/select2.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static '/css/select2.min.css' %}"  />
    <script src="{% static '/js/moment.min.js' %}"></script>

    <script src="{% static '/js/jquery-3.3.1.js' %}"></script>
    <script src="{% static '/js/sweetalert.min.js' %}"></script>
    <script src="{% static '/js/jquery.min.js' %}"></script>
    <script src="{% static '/js/bootstrap.min1.js' %}"></script>
    <script src="{% static '/js/jquery.min1.js' %}"></script>
    <script src="{% static '/js/jquery-ui.min.js' %}"></script>
    <script src="{% static '/js/jspdf.min.js' %}"></script>

    <script src="{% static '/DataTables/datatables.min.js' %}"></script>
    <!-- <script src="{% static '/js/dataTables.bootstrap4.min.js' %}"></script> -->
    <link rel="stylesheet" type="text/css" href="{% static '/DataTables/datatables.min.css' %}"  />


    <link rel="stylesheet" type="text/css" href="{% static '/css/bootstrap.min.css' %}"  />
    <link rel="stylesheet" type="text/css" href="{% static '/css/jquery-ui.css' %}"  />
    
    <script src="{% static '/js/jquery.timepicker.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static '/css/jquery.timepicker.min.css' %}"  />
    
  <!-- swasti link -->

<script type="text/javascript" src="{% static '/daterangepicker-master/moment.min.js'%}"></script>
<script type="text/javascript" src="{% static '/datepicker-master/moment.min.js'%}"></script>
<script type="text/javascript" src="{% static '/daterangepicker-master/daterangepicker.js'%}"></script>

<link rel="stylesheet" type="text/css" href="{%static '/daterangepicker-master/daterangepicker.css'%}" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>

<link rel="stylesheet" type="text/css" href="{% static '/css/forms_common.css' %}" />

</head>
<style>
 input {
  border: 1px solid transparent;
  background-color: #f1f1f1;
  padding: 10px;
  font-size: 16px;
}

input[type=text] {
  background-color: #f1f1f1;
  width: 100%;
}


.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-bottom: none;
  border-top: none;
  z-index: 99;
  /*position the autocomplete items to be the same width as the container:*/
  top: 100%;
  left: 0;
  right: 0;
}

.autocomplete-items div {
  padding: 10px;
  cursor: pointer;
  background-color: #fff; 
  border-bottom: 1px solid #d4d4d4; 
}

/*when hovering an item:*/
.autocomplete-items div:hover {
  background-color: #e9e9e9; 
}

/*when navigating through the items using the arrow keys:*/
.autocomplete-active {
  background-color: DodgerBlue !important; 
  color: #ffffff; 
}




</style>
<body>
  <div>
    <h3 class="report_heading">Search Inspection Report</h3>
  </div>

  <div class="container">
    <div class="container inpt-container mt-5" id="filterForm">        
      <div class="row">
        <div class="col-lg-2">
          <div class="form-group">
              <label for="exampleFormControlSelect1" class="lbl-caption">Date Wise</label>
              <input type="text" style="max-width:100%;height:2em; background-color: #fff;" autocomplete="off" placeholder="Select Date Range" class="form-control dateofInsp" name="dateofInsp" id="date1">
          </div>
        </div>

        

        <div class="col-lg-2">
          <div class="form-group">
              <label for="exampleFormControlSelect1" class="lbl-caption">Designation Wise</label>
              <select class="form-control" data-live-search="true" id="desgn" data-actions-box="true" style="max-width:100%;height:2em;">
                <option>Select</option>
                {% for i in desg_no %}
                <option value="{{i.designation}}">{{i.designation}}</option>
                {% endfor %}
                </select>
          </div>
        </div>
          <div class="col-lg-2">
            <div class="form-group">
              <label for="exampleFormControlSelect1" class="lbl-caption">Section</label>
              <select class="form-control" id="sec" data-live-search="true" data-actions-box="true" style="max-width:100%;height:2em;">
                  <option>Select</option>
                  {% for i in sec_no %}
                  <option value="{{i.section_code}}">{{i.section_code}}</option>
                  {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-lg-2">
            <div class="form-group">
              <label for="exampleFormControlSelect1" class="lbl-caption">Inspection-Type Wise</label>
              <select class="form-control" onchange="getValues()" id="insp" data-live-search="true" data-actions-box="true" style="max-width:100%;height:2em;">
                  <option>Select</option>
                  {% for i in insp_type %}
                  <option value="{{i.name}}">{{i.name}}</option>
                  {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-lg-2">
            <div class="form-group autocomplete">
              <label id="inspcode" for="exampleFormControlSelect1" class="lbl-caption">Value</label>
              <br>
              <!-- <select class="form-control select2" id="insp_val" data-live-search="true" data-actions-box="true">
                  <option>Select</option>
              </select> -->
              <input disabled class="form-control" id="insp_val" type="text" name="myvals" placeholder="Select" style="max-width:100%;height:2em;">
            </div>
          </div>
            
          <div class="col-lg-2">
            <div class="form-group">
              <div class="col">
                <div class="btn-toolbar" role="toolbar" style="margin-top:30px;">
                    <div class="btn-group mr-2" role="group" >
                        <button type="button" id="submit_filter" class="btn btn-warning btn-sm" onclick="searchDetails();">Continue</button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="resetEntries()">Reset</button>
                    </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        </div>

        <div class="container mt-5">
          <div class="row" style="background-image: radial-gradient(circle farthest-side, #fceabb, #f8b500);  color: black ;font-weight: bold;height: 40px; vertical-align: middle;">
            <div class="col-lg-6 my-1">
              <div class="row ml-1">
                Show      
                <div class="col-lg-5">
                  <select name="category" class="form-control-sm" id="selectedCategory" style="width:100%;">
                    <option value="" selected="selected" disabled>Select</option>
                    <option>10</option>
                    <option>50</option>
                  </select>
                </div>
                Entries
              </div>
            </div>       
        
            <div class="col-lg-6 my-1">
              <div class="row float-right mr-2">
                  <button class="btn btn-sm bg-white mr-2" style="height:30px; margin-top: 2px;" type="button" id="filterButton" value="filter" onclick="show_filters(this.val)" >
                    <i class="fa fa-filter fa-sm"></i>
                    Toggle Filter
                  </button>
                          
                  <div class="form-inline float-right">         
                    <div>
                      <input type="text" class="form-control form-control-sm" id="myInput" placeholder="Search Text..." >
                    </div>
                    <div>
                      <i class="fa-solid fa-print my-2 mx-2" onclick="window.print();"></i>
                    </div>          
                  </div>
                </div>
              </div>
        </div> 
        </div> 
    
        <table id="show_details" style="width: 100%;" cellspacing="0" class="table table-striped table-bordered table-data" >
          <thead>
            <tr style="text-align:left">
              <th scope="col">No.</th>
              <th scope="col">Insp. Date</th>
              <th scope="col">Inspection Type</th>
              <th scope="col">Inspecting Officer</th>
              <th scope="col">Section</th>
              <th style="width:20%" scope="col">Action</th>
            </tr>
          </thead>
          <tbody id="details121"> </tbody>
      </table>

  </div>
        
</body>
<script>
  $('.select2').select2();
</script>
<script>
</script>
<script>
  $("#myInput").on("keyup", function(){
  var value = $(this).val().toLowerCase();
  // alert(value)
  $("#tbody_IC tr").filter(function() {
  $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)

});

});
  //$(function () {
    //     $("#btnReset").bind("click", function () {
    //         // $("#desgn")[0].selectedIndex = 0;
    //         $('#date1').val('');
    //         $('#desgn').val('');
    //         $('#insp').val('');
    //     });
    // });
  function autocomplete(inp, arr) {
  /*the autocomplete function takes two arguments,
  the text field element and an array of possible autocompleted values:*/
  var currentFocus;
  /*execute a function when someone writes in the text field:*/
  inp.addEventListener("input", function(e) {
      var a, b, i, val = this.value;
      /*close any already open lists of autocompleted values*/
      closeAllLists();
      if (!val) { return false;}
      currentFocus = -1;
      /*create a DIV element that will contain the items (values):*/
      a = document.createElement("DIV");
      a.setAttribute("id", this.id + "autocomplete-list");
      a.setAttribute("class", "autocomplete-items");
      /*append the DIV element as a child of the autocomplete container:*/
      this.parentNode.appendChild(a);
      /*for each item in the array...*/
      for (i = 0; i < arr.length; i++) {
        /*check if the item starts with the same letters as the text field value:*/
        if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
          /*create a DIV element for each matching element:*/
          b = document.createElement("DIV");
          /*make the matching letters bold:*/
          b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
          b.innerHTML += arr[i].substr(val.length);
          /*insert a input field that will hold the current array item's value:*/
          b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
          /*execute a function when someone clicks on the item value (DIV element):*/
          b.addEventListener("click", function(e) {
              /*insert the value for the autocomplete text field:*/
              inp.value = this.getElementsByTagName("input")[0].value;
              /*close the list of autocompleted values,
              (or any other open lists of autocompleted values:*/
              closeAllLists();
          });
          a.appendChild(b);
        }
      }
  });
  /*execute a function presses a key on the keyboard:*/
  inp.addEventListener("keydown", function(e) {
      var x = document.getElementById(this.id + "autocomplete-list");
      if (x) x = x.getElementsByTagName("div");
      if (e.keyCode == 40) {
        /*If the arrow DOWN key is pressed,
        increase the currentFocus variable:*/
        currentFocus++;
        /*and and make the current item more visible:*/
        addActive(x);
      } else if (e.keyCode == 38) { //up
        /*If the arrow UP key is pressed,
        decrease the currentFocus variable:*/
        currentFocus--;
        /*and and make the current item more visible:*/
        addActive(x);
      } else if (e.keyCode == 13) {
        /*If the ENTER key is pressed, prevent the form from being submitted,*/
        e.preventDefault();
        if (currentFocus > -1) {
          /*and simulate a click on the "active" item:*/
          if (x) x[currentFocus].click();
        }
      }
  });
  function addActive(x) {
    /*a function to classify an item as "active":*/
    if (!x) return false;
    /*start by removing the "active" class on all items:*/
    removeActive(x);
    if (currentFocus >= x.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = (x.length - 1);
    /*add class "autocomplete-active":*/
    x[currentFocus].classList.add("autocomplete-active");
  }
  function removeActive(x) {
    /*a function to remove the "active" class from all autocomplete items:*/
    for (var i = 0; i < x.length; i++) {
      x[i].classList.remove("autocomplete-active");
    }
  }
  function closeAllLists(elmnt) {
    /*close all autocomplete lists in the document,
    except the one passed as an argument:*/
    var x = document.getElementsByClassName("autocomplete-items");
    for (var i = 0; i < x.length; i++) {
      if (elmnt != x[i] && elmnt != inp) {
        x[i].parentNode.removeChild(x[i]);
      }
    }
  }
  /*execute a function when someone clicks in the document:*/
  document.addEventListener("click", function (e) {
      closeAllLists(e.target);
  });
}
var values = []  
function getValues(){
    $("#insp_val").prop('disabled', false);
    $('#insp_val').attr('placeholder', 'Select')
    var insp = document.getElementById('insp').value;
    var insp_val = document.getElementById('insp_val').value;
    if(insp=="Station"){
      $('#insp_val').attr('placeholder', 'Enter Station Code')
    }
    else if(insp=="Running Room"){
      $('#insp_val').attr('placeholder', 'Enter RR Code')
    }
    else{
      $('#insp_val').attr('placeholder', 'Enter Train No.')
    }
    
      data = {
        'insp': insp,
        'insp_val':insp_val,
      }
      $.ajax({
        type: 'GET',
        url: "{% url 'getValues' %}",
        data: data,
        success: function (response) {
          // $('#insp_val').empty();
          // let row = '<option>Select</option>';
          // console.log('response.length',response.length);
          // for (let i = 0; i < response.length; i++) {
          //   row += '<option>' + response[i] + ' </option>';
          // }
          // $('#insp_val').append(row);
          values = response;
          console.log("vals",values)
          autocomplete(document.getElementById("insp_val"), values);
        }
      })
}



  function searchDetails(){

     var date1 = $('#date1').val();
     console.log(date1)
     var desgn = $('#desgn').val();
     var insp = $('#insp').val();
     var insp_val = $('#insp_val').val();
     var sec = $('#sec').val()
     data = {'date':date1,'desgn':desgn,'insp':insp,'insp_val':insp_val,'sec':sec}
     $("#details121").empty();
     $.ajax({
            url:'{% url "searchDetails" %}',
            dataType: 'json',
            type: 'GET',
            data: data,
            success: function(response)
            {
              var table=$('#show_details').DataTable();
              table.destroy();
                
                console.log(response.details)
                $('#show_details tbody').empty();
                var s=0;
                for(i in response.details)
                {
                  s=s+1;

                    $('#show_details tbody').append
                    (
                        `<tr>
                            <td>${s}</td>
                            <td>${response.details[i].inspected_on}</td>
                            <td>${response.details[i].instype} Inspection of ${response.details[i].l1} ${response.details[i].l2}</td>
                            <td>${response.details[i].designation}</td>
                            <td>${response.details[i].section_code}</td>
                            <td><button type="button" id="${response.details[i].einspno}" onclick="viewDet(this.id)" class="btn btn-success">View</button>
                              <button type="button" id="${response.details[i].einspno}" onclick="pdfDet(this.id)" class="btn btn-danger">PDF</button>
                            </td>
                        </tr>`
                    )
                }
                // document.getElementById("num").innerHTML = response.details.length;
                // var table=$('#show_details').DataTable();
                var table = $('#show_details'). DataTable({
                                            // scrollX: true,
                                            // scrollY:true,
                                            // scrollCollapse: true,
                                            // paging: true,
                                            scrollX: false,
                                            pageLength : 10,
                                            retrieve: true,
                                            "lengthChange": false,
                                            searching: false, 
                                            pagingType: "simple",
                                            "language": {
                                            "info": "Page _PAGE_ of _PAGES_",
                                            }
                                          });     
            }
        })
  }
  $(document).ready(function() {
    $("#filterForm").show();
    $("#myInput").on("keyup", function(){
  var value = $(this).val().toLowerCase();
  // alert(value)
  $("#details121 tr").filter(function() {
  $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)

});

});
    var s=0;
    $("#details121").empty();
    
    $.ajax
        ({
            url:'{% url "showDetails" %}',
            dataType: 'json',
            type: 'GET',
            success: function(response)
            {
                
                // table.destroy();
                // console.log(response.details)
                for(i in response.details)
                {
                  s=s+1
                    $('#show_details tbody').append
                    (
                        `<tr>
                            <td>${s}</td>
                            <td>${response.details[i].inspected_on}</td>
                            <td>${response.details[i].instype} Inspection of ${response.details[i].l1} ${response.details[i].l2}</td>
                            <td>${response.details[i].designation}</td>
                            <td>${response.details[i].section_code}</td>
                            <td><button type="button" id="${response.details[i].einspno}" onclick="viewDet(this.id)" class="btn btn-success">View</button>
                            <button type="button" id="${response.details[i].einspno}" onclick="pdfDet(this.id)" class="btn btn-danger">PDF</button>
                            </td>
                        </tr>`
                    )
                }
                // document.getElementById("num").innerHTML = response.details.length;
                var table = $('#show_details'). DataTable({
                                            // scrollX: true,
                                            // scrollY:true,
                                            // scrollCollapse: true,
                                            // paging: true,
                                            scrollX: false,
                                            pageLength : 10,
                                            retrieve: true,
                                            "lengthChange": false,
                                            searching: false, 
                                            pagingType: "simple",
                                            "language": {
                                            "info": "Page _PAGE_ of _PAGES_",
                                            }
                                          }); 
            }
        })
  });


  function resetEntries(){

    $("#myInput").on("keyup", function(){
  var value = $(this).val().toLowerCase();
  // alert(value)
  $("#tbody_IC tr").filter(function() {
  $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)

});

});
    
    $("#details121").empty();
    $('#date1').val('');
    $('#desgn').val('');
    $('#sec').val('');
    $('#insp').val('');
    $('#insp_val').val('');
    $.ajax
        ({
            url:'{% url "showDetails" %}',
            dataType: 'json',
            type: 'GET',
            success: function(response)
            {
              var table=$('#show_details').DataTable();
              table.destroy();
                
                // table.destroy();
                
                // console.log(response.details)
                var s=0;
                for(i in response.details)
                {
                  s=s+1
                    $('#show_details tbody').append
                    (
                        `<tr>
                            <td>${s}</td>
                            <td>${response.details[i].inspected_on}</td>
                            <td>${response.details[i].instype} Inspection of ${response.details[i].l1} ${response.details[i].l2}</td>
                            <td>${response.details[i].designation}</td>
                            <td>${response.details[i].section_code}</td>
                            <td><button type="button" id="${response.details[i].einspno}" onclick="viewDet(this.id)" class="btn btn-success">View</button>
                            <button type="button" id="${response.details[i].einspno}" onclick="pdfDet(this.id)" class="btn btn-danger">PDF</button>
                            </td>
                        </tr>`
                    )
                }
                var table = $('#show_details'). DataTable({
                                            // scrollX: true,
                                            // scrollY:true,
                                            // scrollCollapse: true,
                                            // paging: true,
                                            pageLength: 10,
                                            "lengthChange": false,
                                            searching: false,
                                            pagingType: "simple",
                                            "language": {
                                              "info": "Page _PAGE_ of _PAGES_",
                                            }
            }); 
            }
        })
  }

  function show_filters(val){
    $('#filterForm').toggle();
  }

  function viewDet(id)
  {
    window.open("{% url 'viewDetails' %}"+"?id="+id)
    // window.location.href="{% url 'viewDetails' %}"+"?id="+id;
  }
  function pdfDet(id)
  {
    window.open("{% url 'pdfDetails' %}"+"?id="+id);
  }
  $( function() {
    var currentdate= new Date();
    $( ".dateofInsp" ).daterangepicker({ 
      maxDate: currentdate,
      autoclose:true,
      autoApply:true,
      autoUpdateInput:false,
      dateFormat: "dd-mm-yy",
      endDate:"currentdate",
      changeMonth : true,
      changeYear : true,
      todayHighlight: true,
      clearBtn : true 
    });
    $( ".dateofInsp" ).on('apply.daterangepicker', function(ev, picker) {
      $(this).val(picker.startDate.format('DD/MM/YY') + '-' + picker.endDate.format('DD/MM/YY'));
    });
 } );
</script>

</html>
{% endblock content %}