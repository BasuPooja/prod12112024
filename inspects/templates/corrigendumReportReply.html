{% extends 'base.html' %} 
{% block content %}

{% load static %}

<head>
  <link rel="stylesheet" type="text/css" media="screen" href="{% static '/css/forms_common.css' %}">  
  <script type="text/javascript">
    $(".sidebar").addClass('close');
  </script>
</head>
<br>


<body>

    <h3 class="report_heading">Corrigendum Details of {% for ab in ins_title %} {{ab.inspection_note_no}}  dtd.{{ab.inspected_on|date:'d/m/y'}} {% endfor %}
    </h3>
      
<br>


<form method="POST"> 
  {% csrf_token %}
 
  {% for i in ins_title %}

  <div class="container">
    <div class="col-lg-12 form-group">
      <label for="start" >Title</label>
      <textarea class="form-control" maxlength="150"   id="titleinsp"  name="titleinsp" readonly>{{i.inspection_title}}</textarea>
    </div>
  </div> 
  {% endfor %}
  <br>

  <div class="container"> 
          <div class="col-md-12"> 
            <table id="table1" class="table table-striped table-bordered center table-data " >

            <thead >
                <tr>
                  <th width="5%">Item.No.</th>
                  <th width="35%"> Inspection Para</th>
                  <th width="10%">Action By</th>
                  <th width="35%">Remark</th>
                  <th width="10%">Reverted on</th>
                  <th width="5%">Action</th>
               </tr>
          
            </thead>
            
            
            <tbody  id="addworkmech">
            {% for j in item_details1 %}
            {% if j.type == 'S' %}
            <tr>
              <td><div style="text-align: center; width:5px; font-family: verdana;">{{j.des_id}}</div></td>
                <td><div><b><p id='heading{{j.des_id}}' title="{{j.item_title}}" >{{j.item_title|truncatechars:150}}</p></b></div></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            {% elif j.type == 'H' %}
            <tr>
              <td><div style="text-align: center; width:5px; font-family: verdana;">{{j.des_id}}</div></td>
                <td><div><b><p id='heading{{j.des_id}}' title="{{j.item_title}}" >{{j.item_title|truncatechars:150}}</p></b></div></td>
              {% if j.chk_cts == 'YES' %}
                
                
                
                    <td>
                      <table width="100%" class="table">
                        {% for z in j.mrkoffi %}
                        <tr>
                          <td style="line-height: 2.05857143;"><input id="officer{{z.marked_no}}" value="{{z.marked_to__designation}}" readonly></td>
                        </tr>
                        
                        {% endfor %}
                      </table>
                    </td>
              
                    <td>
                      <table width="100%">
                      {% for z in j.mrkoffi %}
                        <tr>
                          <td style="line-height: 2.42857143;">{{z.revert}}</td>
                        </tr>
                        
                        {% endfor %}
                      </table>
                    </td>
                    <td>
                      <table width="100%" class="table">
                        {% for z in j.mrkoffi %}
                          {% if z.reverted_on %}
                            <tr>
                              <td style="line-height: 2.42857143;">{{z.reverted_on|date:'d/m/y'}}</td>
                            </tr>
                            
                            {% else %}
                            <tr>
                              <td style="line-height: 2.42857143;">-</td>
                            </tr>

                          {% endif %}
                        
                        {% endfor %}
                      </table>
                    </td>
                    <td>

                      <table width="100%" class="table">
                        {% for z in j.mrkoffi %}
                        {% if z.status != 'R' %}
                        <tr >
                              <td style="line-height: 2.42857143;">
                                
                              
                                  <button type="button" class="btn btn-outline-primary btn-sm" onclick='fetch_marked_officers("{{z.marked_no}}")' data-toggle="modal" data-target="#actionModal">
                                    <i class="far fa-edit"></i>
                                  </button>
                              
                              </td>
                        </tr>
                        {%else%}
                        <tr><td>Corrigendum Issued</td></tr>
                        {%endif%}
                        {% endfor %}
                      </table>

                    </td>
              {% else %}
            
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              

              {% endif %}
          </tr>




            {% elif j.type == 'SH' %}
            <tr>
                <td><p style="text-align: center; width:5px; font-family: verdana;" id='itemno{{j.des_id}}'>{{j.des_id}}</p></td>
                <td ><p id='observation{{j.des_id}}' title="{{j.observation}}">{{j.observation|truncatechars:150}}</p></td>
                
                
                  <td>
                
                    <table width="100%" class="table">
                      {% for z in j.mrkoffi %}
                      <tr>
                        <td style="line-height: 2.05857143;"><input id="officer{{z.marked_no}}" value="{{z.marked_to__designation}}" readonly></td>
                      </tr>
                      
                      {% endfor %}
                    </table>
                
                  </td>
                
                  <td>
                    <table width="100%">
                    {% for z in j.mrkoffi %}
                    <tr>
                      <td style="line-height: 2.42857143;">{{z.revert}}</td>
                    </tr>
                    
                    {% endfor %}
                  </table>
                </td>
              

                  <td>
                    <table width="100%" class="table">
                      {% for z in j.mrkoffi %}
                        {% if z.reverted_on %}
                          <tr>
                            <td style="line-height: 2.42857143;">{{z.reverted_on|date:'d/m/y'}}</td>
                          </tr>
                          
                          {% else %}
                          <tr>
                            <td style="line-height: 2.42857143;">-</td>
                          </tr>

                        {% endif %}
                      
                      {% endfor %}
                    </table>
                  </td>

                  <td>
                      <table width="100%" class="table">
                        {% for z in j.mrkoffi %}
                        {% if z.status != 'R' %}
                        <tr >
                              <td style="line-height: 2.42857143;">
                                
                               
                                  <button type="button" class="btn btn-outline-primary btn-sm" onclick='fetch_marked_officers("{{z.marked_no}}")' data-toggle="modal" data-target="#actionModal">
                                    <i class="far fa-edit"></i>
                                  </button>
                              
                              </td>
                        </tr>
                        {%else%}
                        <tr><td>Corrigendum Issued</td></tr>
                        {%endif%}
                        {% endfor %}
                      </table>
                  </td>
                
              </tr>
                
            {% else %}
            <tr>
              <td><div style="text-align: center; width:5px; font-family:verdana;"></div></td>
              <td>{{j.des_id}}<p id='subheading{{j.des_id}}' autocomplete1 = "off"  style="margin-left: 80px;" >{{j.item_subtitle}}</p></td>
                
            </tr>
            {% endif  %}  
          {% endfor %}
          
        </tbody>
            
            </table>
          </div>
    </div>

</form>
<br>
<br>


<input type="text" id="insp_number" value="{{insp_number}}" hidden>

<!-- Modal -->
<div class="modal fade" id="actionModal" tabindex="-1" role="dialog" aria-labelledby="actionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="report_heading" id="actionModalLabel">Action</h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="container">


          <div class="row">
            <div class="col-4">
                <label for="" style="font-weight: bold;">Old Designation</label>
                <input type="text" class="form-control" id="olddesig" readonly>
            </div>

            <div class="col-4">
              <label for="" style="font-weight: bold;">Reverted On</label>
              <input type="text" class="form-control" id="reverted" readonly>
            </div>

            <div class="col-4">
              <label for="" style="font-weight: bold;">Remark</label>
              <input type="text" class="form-control" id="remrk" readonly>
            </div>
          </div>
          <br>
          <div class="row">
            
            <div class="col-6">
              <div class="row">
                <label for="" style="font-weight: bold;">Edit Marked Officer</label><span style="color:red;font-weight:bold">*</span>
              </div>
              <div class="row" style="width: 100%;">
                <div class="col-12" style="width: 100%;">
                  <select class=" form-control sel-control" id="new_desig" required class="custom-select" style="width: 100%;">
                    <option value="" disabled selected>Select Designation</option>
                    {% for j in all_desig %}
                    <option value="{{j.designation_code}}">{{j.designation}}</option>
                    {% endfor %}
        
                  </select>
                </div>
                
                <input type="text" id="marked_num" hidden>
              </div>
                
            </div>
            <div class="col-6">
              <label for="remark" style="font-weight: bold;">Add Remark</label><span style="color:red;font-weight:bold">*</span>
              <textarea  id="remark" class="form-control" placeholder="Maximum length 200 words " maxlength="200" required></textarea>
            </div>

          </div>
          
        </div>
      </div>
      <div class="modal-footer">
        
        <button type="button" class="btn btn-success" onclick="saveDesigValue(this);" {% if request.session.userrole == 'guest' %} hidden {% endif %}>Issue Corrigendum</button>
        <button type="button" class="btn btn-secondary" id="close_id" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<br>
</body>

<script>
  $(document).ready(function(){
$("#new_desig").select2();
  });





function saveDesigValue(el){
    let new_desig = $('#new_desig').val()
    if (new_desig == ''){
      alert('Select Designation')
      return false;
    }
    let remark = $('#remark').val()
    let marked_num = $('#marked_num').val()
    let olddesig = $('#olddesig').val()
 
    if (remark=='')
    {
      alert('Please add some remark')
      return false;
    }
    
      $.ajax({
          type : 'GET',
          url : "{% url 'saveCorrigendumOff' %}",
          dataType : 'json',
          data : {new_desig, remark, marked_num, olddesig},

          success : function(response){
              window.location.reload()
              $('#close_id').click()      
          }
          
      });

}
function formatDate(date) {
    var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();

    if (month.length < 2) 
        month = '0' + month;
    if (day.length < 2) 
        day = '0' + day;
    let newyear = String(year).slice(2, 5)
    return [day,month,newyear].join('/');
}

function fetch_marked_officers(mark){

          $('#marked_num').val(mark)
  
        $.ajax({
            type : 'GET',
            url : "{% url 'fetch_marked_officers' %}",
            dataType : 'json',
            data : {mark},

            success : function(response){
          
                $('#olddesig').val(response[0].designation)
                $('#reverted').val(formatDate(response[0].reverted_on))
                $('#remrk').val(response[0].revert)
                $('#olddesig').val(response[0].designation)
                 
            }
            
        });

    
}
</script>
{% endblock %}  