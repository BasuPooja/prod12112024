{% extends 'base.html' %} 
{% block content %}

{% load static %}

<meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  
<head>
  <link rel="stylesheet" type="text/css" media="screen" href="{% static '/css/forms_common.css' %}">  
  <!-- <script src="{% static '/js/jquery-3.4.1.min.js' %}" ></script>
    <script src="{% static '/js/popper.min.js' %}" ></script>
    <script src="{% static '/js/Chart.min.js' %}"></script>
    <script src="{% static '/js/jquery-3.3.1.slim.min.js' %}" ></script>
    <script src="{% static '/js/bootstrap.min.js' %}" ></script> -->
  <style>
    .wrap.active {
    display: block;
    visibility: visible;
    box-shadow: 2px 3px 16px silver;
    transition: all 600ms;
    transform: translateY(0px);
    transition: all 0.5s;
}
.wrap {
    position: fixed;
    overflow: hidden;
    top: 10%;
    right: 10%;
    bottom: 85px;
    left: 10%;
    padding: 12px;
    display: block !important;
    border-radius: 4px;
    transform: translateY(20px);
    transition: all 0.5s;
    visibility: hidden;
    z-index: 9999;
    height: 85vh;
}

.wrap-1.active {
    display: block;
    visibility: visible;
    box-shadow: 2px 3px 16px silver;
    transition: all 600ms;
    transform: translateY(0px);
    transition: all 0.5s;
}
.wrap-1 {
    position: fixed;
    overflow: hidden;
    top: 10%;
    right: 10%;
    bottom: 85px;
    left: 10%;
    padding: 12px;
    display: block !important;
    border-radius: 4px;
    transform: translateY(20px);
    transition: all 0.5s;
    visibility: hidden;
    z-index: 9999;
    height: 85vh;
}
.wrap.active .content,.wrap-1.active .content  {
    position: relative;
    z-index: 1;
    opacity: 1;
    transition: all 600ms cubic-bezier(0.55, 0.055, 0.675, 0.19);
}
.wrap .content, .wrap-1 .content {
    opacity: 0;
}
.wrap.active:before, .wrap-1.active:before {
    height: 2000px;
    width: 2000px;
    border-radius: 50%;
    top: 50%;
    left: 50%;
    margin-left: -1000px;
    margin-top: -1000px;
    display: block;
    -webkit-transition: all 600ms cubic-bezier(0.215, 0.61, 0.355, 1);
    transition: all 600ms cubic-bezier(0.215, 0.61, 0.355, 1);
}
.wrap:before, .wrap-1:before {
    position: fixed;
    width: 1px;
    height: 1px;
    background: white;
    content: "";
    bottom: 10px;
    left: 50%;
    top: 95%;
    color: #fff;
    border-radius: 50%;
    -webkit-transition: all 600ms cubic-bezier(0.215, 0.61, 0.355, 1);
    transition: all 600ms cubic-bezier(0.215, 0.61, 0.355, 1);
}
.wrap::-webkit-scrollbar, .wrap-1::-webkit-scrollbar {
    width: 10px;  /* Remove scrollbar space */
    background: #dedede;
}
/* Optional: show position indicator in red */
.wrap::-webkit-scrollbar-thumb,.wrap-1::-webkit-scrollbar-thumb {
    background: #FF0000;
}
  </style>
</head>


<body>

  <h3 class="report_heading">Reply of {% for ab in insp_details %} {{ab.inspection_note_no}}  dtd. {{ab.inspected_on}} {% endfor %}</h3>
   
  
<br>


<form method="POST"> 
{% csrf_token %}
 
<br>

{% for i in insp_details %}

<div class="container">
  <div class="col-lg-12 form-group">
    <label for="start" >Title</label>
    <textarea class="form-control" maxlength="150"   id="titleinsp"  name="titleinsp" readonly>{{i.inspection_title}}</textarea>
    <input type="text" id="insp_number" value="{{i.einspno}}" hidden>
  </div>
</div> 
{% endfor %}
<br>
<div class="container"> 
    <table id="table1" class="table table-striped table-bordered center table-data " >
        <thead>
            <tr style="margin-left: 5em;">
                <th style= "text-align: left; border-top: 1px solid black; border-bottom: 1px solid black;width: 5%;">Item.No.</th>
                <th style= "text-align: left; border-top: 1px solid black; border-bottom: 1px solid black;width: 30%;"> Inspection Para</th>
                <th  style= "text-align: left; border-top: 1px solid black; border-bottom: 1px solid black;">
                <table width="100%" style="border: none;">
                    <th style= "text-align: left;border-top: 1px solid #0066cc; border-bottom: 1px solid #0066cc;border-left: 1px solid #0066cc;border-right: 1px solid #0066cc; width: 20%;">Action By</th>
                    <th style= "text-align: left;border-top: 1px solid #0066cc; border-bottom: 1px solid #0066cc;border-left: 1px solid #0066cc;border-right: 1px solid #0066cc; width: 40%;">Reply Received</th>
                    <th style= "text-align: left;border-top: 1px solid #0066cc; border-bottom: 1px solid #0066cc;border-left: 1px solid #0066cc;border-right: 1px solid #0066cc; width: 10%;">Target</th>
                    <th style= "text-align: left;border-top: 1px solid #0066cc; border-bottom: 1px solid #0066cc;border-left: 1px solid #0066cc;border-right: 1px solid #0066cc; width: 10%;">Days Taken</th>
                    <th style= "text-align: center;border-top: 1px solid #0066cc; border-bottom: 1px solid #0066cc;border-left: 1px solid #0066cc;border-right: 1px solid #0066cc; width: 20%;">Reject Reply</th>
                </table>
                </th>
                <!-- <th style= "text-align: left; border-top: 1px solid black; border-bottom: 1px solid black;width: 5%;">% Compliance</th>
                <th style= "text-align: left; border-top: 1px solid black; border-bottom: 1px solid black;width: 5%;">Priority</th> -->
            </tr>
        </thead>

        <tbody  id="addworkmech">
            {% for j in listgrid %}
            <tr>
                <td><div style="text-align: center; width:5px; font-family: verdana;">{{j.sr_no}}</div></td>
                <td><div><b><p id='heading{{j.des_id}}'>
                    {{j.question}} <br>
                    Observation: {{j.value}}<br>
                    Remarks: {{j.report_act}}</p></b></div></td>
                <td>
                    <table width="100%" class="table">
                            
                            <tr>
                                <td style="line-height: 2.42857143; width: 20%;">
                                  {% if j.status_flag == 4 %}
                                  <span style="color: green;">{{j.marked_to}}</span>
                                  {% else %}
                                  <span style="color: red;">{{j.marked_to}}</span>
                                  {% endif %}
                                </td>

                                <td style="line-height: 2.42857143;width: 40%;">{{j.compliance}}</td>
                                <td style="line-height: 2.42857143;width: 10%;">{{j.tgt_date}}</td>
                                <td style="line-height: 2.42857143;width: 10%;"><span style="color: black;">{{j.days}}</span></td>
                                <td style="line-height: 2.4857143;width: 20%;" >
                                    {% if j.status_flag == 4 and j.revert != 1 %}
                                    <div style="text-align: center;"><a  value="reject" onclick="actionBtnFunction(this);"   id="{{j.marked_no}}" data-toggle="modal" data-target="#actionModal"><span style="font-weight: bold; color: green;"><i class="fas fa-dot-circle fa-2x"></i></span></a>
                                    </div>
                                    {% elif j.status_flag == 1 and j.reject == 1 %}
                                    <div style="text-align: center;"><a  value="reject" onclick="actionBtnFunction(this);"   id="{{j.marked_no}}" data-toggle="modal" data-target="#actionModal"><span style="font-weight: bold; color: #ff6961;"><i class="fas fa-dot-circle fa-2x"></i></span></a>
                                    </div>
                                    {% elif j.status_flag == 4 and j.revert == 1 %}
                                    <div style="text-align: center;"><a  value="reject" href="{% url 'corrigendumReportReply_phase2' insp_no %}"  target="blank"   id="{{j.marked_no}}" ><span style="font-weight: bold; color: rgb(255, 173, 80);"><i class="fas fa-dot-circle fa-2x"></i></span></a>
                                    </div>
                                   
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>                    
                    </table>
                </td>
            {% endfor %}
            
        </tbody>
    </table>
 
  </div>

</form>
<br>
<br>

<!-- action Modal -->
<div class="modal fade" id="actionModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="report_heading " id="exampleModalLabel">Action</h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="containar">

          <div class="row">
              <table id="m_table" class="table table-data table-sm">
                  <thead>
                      <tr>
                          <th>S.No</th>
                          <th>Remark</th>
                          <th>Reply On</th>
                          
                          <th>Status</th>
                      </tr>
                  </thead>
                  <tbody>
                    
                  </tbody>

              </table>
              <div class="col text-id">
                
              </div>
          </div>

          <div class="row">
              <input type="text" id="marked_no" hidden>
              
              <div class="col">
                  

                  <div>
                      <label for="remark_id"><b>Add Remark</b></label>
                      <textarea class="form-control" placeholder="Max length 200 character" style="height: 50px;" name="remark_id" id="remark_id" cols="30" rows="10" maxlength="200"></textarea>
                  </div>
              </div>

          </div>

        </div>
      </div>
      <div class="modal-footer">
       
        <button type="button" class="btn btn-secondary" id="m_close" data-dismiss="modal" >Close</button>
        
        <button type="button" class="btn btn-primary" id="save_btn_id" onclick="saveActionForm();" {% if request.session.userrole == 'guest' %} hidden {% endif %}>Save & Revert</button>
        
        
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="content">
    <button class="btn btn-danger" onclick="closePpln();">&times;</button>
    <iframe src="" style="width:100%;height:82vh;border:0px;" id="frmDash"></iframe>
  </div>
</div>

</body>
<script>

  function actionBtnFunction(el){
    
    let insp_number = $('#insp_number').val()
    let mark_officer_id = el.id
    let phase = '2'
    $('#marked_no').val(mark_officer_id)
    $('#m_table tbody').empty()
    $.ajax({
        type : 'GET',
        url : "{% url 'actionBtnFunction_ajax' %}",
        dataType : 'json',
        data : {insp_number, mark_officer_id, phase},
        success : function(response){
            
            for(let y in response.obj){
              if(response.obj[y].reject == '1' && response.obj[y].status_flag == 1){
                    document.getElementById('save_btn_id').disabled = true;
                    document.getElementById('remark_id').disabled = true;
                  }
                  else{
                    document.getElementById('save_btn_id').disabled = false;
                    document.getElementById('remark_id').disabled = false;
                  }
            }
            if(response.rem_obj.length > 0){
              let content = ''
              
              for(i in response.rem_obj){
                  $('#m_table tbody').empty()
                  let sno = parseInt(i+1)
                  content += '<tr>'
                          +'<td>'+sno+'</td>'
                          +'<td>'+response.rem_obj[i].remark+'</td>'
                          
                          +'<td>'+ formatDate(response.rem_obj[i].rejected_on)+'</td>'
                          +'<td>'+ response.rem_obj[i].status +'</td>'
              
                  content +=  '</tr>'
                  
              }
              $('#m_table tbody').append(content)
            }else{
              $('.text-id').html('<div style="text-align: center;"><h6>No Remark</h6></div>')
            }
  
            
        }
   });
  }
  
  function saveActionForm(){
    // let action_option = $('#action_option').val()
    
    let mark_num= $('#marked_no').val()
    let remark_id= $('#remark_id').val()
    let insp_number= $('#insp_number').val()
    let phase ='2';
    // alert(mark_num)
    // alert(remark_id)
    // alert(insp_number)
    if(remark_id == ''){
        alert('Please add some remark')
        return false;
    }
        
    $.ajax({
        type : 'GET',
        url : "{% url 'save_mark_reply_ajax' %}",
        dataType : 'json',
        data : {mark_num, remark_id, insp_number, phase},
        success : function(response){
      
            $('#m_close').click()
  
            window.location.reload()
            
          
        }
   })
  }
  
  
  function formatDate(date) {
      var d = new Date(date),
          month = '' + (d.getMonth() + 1),
          day = '' + d.getDate(),
          year = d.getFullYear();
  
      if (month.length < 2) 
          month = '0' + month;
      if (day.length < 2) 
          day = '0' + day;
      let newyear = String(year).slice(2, 5)
      return [day,month,newyear].join('/');
  }
  
  </script>

{% endblock %}  